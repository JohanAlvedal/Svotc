title: SVOTC Main
icon: ""
badges:
  - type: entity
    entity: person.johan
    show_entity_picture: true
  - type: custom:mushroom-template-badge
    content: Laddbox
    icon: mdi:ev-plug-type2
    color: green
    tap_action:
      action: navigate
      navigation_path: /lovelace/laddbox
  - type: entity
    show_name: false
    show_state: true
    show_icon: true
    tap_action:
      action: navigate
      navigation_path: /dashboard-data/7
    entity: sensor.nordpool_official
  - type: custom:mushroom-template-badge
    content: FÃ¶rbrukning
    icon: mdi:power-plug
    color: blue
    tap_action:
      action: navigate
      navigation_path: /dashboard-data/8
  - type: custom:mushroom-template-badge
    icon: mdi:mushroom
    color: red
    content: Jul
    tap_action:
      action: navigate
      navigation_path: /lovelace/jul
  - type: custom:mushroom-template-badge
    content: Tariff
    icon: mdi:power-plug
    color: blue
    tap_action:
      action: navigate
      navigation_path: /lovelace/9
  - type: custom:mushroom-template-badge
    content: System
    icon: mdi:server
    color: green
    tap_action:
      action: navigate
      navigation_path: /lovelace/system
cards: []
type: sections
sections:
  - type: grid
    cards:
      - type: entities
        title: ğŸ›ï¸ SVOTC Kontroller
        state_color: true
        show_header_toggle: false
        entities:
          - entity: input_select.svotc_mode
            name: DriftslÃ¤ge
            icon: mdi:toggle-switch
          - type: section
            label: KomfortinstÃ¤llningar
          - entity: input_number.svotc_comfort_temperature
            name: MÃ¥ltemperatur
            icon: mdi:target
          - entity: input_number.svotc_comfort_guard_activate_below_c
            name: Skydd vid (under mÃ¥l)
            icon: mdi:shield-alert
          - entity: input_number.svotc_comfort_guard_deactivate_above_c
            name: Skydd vid (Ã¶ver mÃ¥l)
            icon: mdi:shield-check
          - type: section
            label: Prisoptimering
          - entity: input_number.svotc_brake_aggressiveness
            name: Broms (0-5)
            icon: mdi:speedometer-slow
          - entity: input_number.svotc_heat_aggressiveness
            name: VÃ¤rme (0-5)
            icon: mdi:fire
          - entity: input_number.svotc_brake_hold_offset_c
            name: Max bromsoffset (Â°C)
            icon: mdi:thermometer-minus
          - entity: input_boolean.svotc_comfort_guard_enabled
      - type: custom:mini-graph-card
        name: ğŸ“ˆ Offset-utveckling (24h)
        hours_to_show: 24
        points_per_hour: 4
        line_width: 3
        font_size: 75
        animate: true
        show:
          labels: true
          legend: true
          icon: false
        entities:
          - entity: input_number.svotc_requested_offset_c
            name: BegÃ¤rd offset
            color: "#f39c12"
            show_state: true
          - entity: input_number.svotc_applied_offset_c
            name: TillÃ¤mpad offset
            color: "#e67e22"
            show_state: true
      - type: custom:mini-graph-card
        name: ğŸŒ¡ï¸ TemperaturÃ¶versikt (24h)
        hours_to_show: 24
        points_per_hour: 4
        line_width: 2
        font_size: 75
        animate: true
        show:
          labels: true
          legend: true
          icon: false
        entities:
          - entity: sensor.svotc_src_outdoor
            name: Utomhus (verklig)
            color: "#3498db"
            show_state: true
          - entity: sensor.svotc_virtual_outdoor_temperature
            name: Virtuell ute (â†’VP)
            color: "#9b59b6"
            show_state: true
      - type: custom:mini-graph-card
        name: ğŸ’µ Elpris (24h)
        hours_to_show: 24
        points_per_hour: 4
        line_width: 2
        font_size: 75
        animate: true
        show:
          labels: true
          legend: true
          icon: false
        entities:
          - entity: sensor.nordpool_official
            name: Elpris
            color: "#3498db"
            show_state: true
      - type: horizontal-stack
        cards:
          - type: entity
            entity: input_select.svotc_mode
            name: SVOTC LÃ¤ge
            icon: mdi:power
          - type: entity
            entity: binary_sensor.svotc_inputs_healthy
            name: System OK
            icon: mdi:heart-pulse
      - type: horizontal-stack
        cards:
          - type: entity
            entity: binary_sensor.svotc_comfort_guard_active
            name: Komfortskydd
            icon: mdi:shield-home
          - type: entity
            entity: input_text.svotc_reason_code
            name: Strategi
            icon: mdi:brain
      - type: entities
        title: ğŸ”¬ Diagnostik
        state_color: true
        show_header_toggle: false
        entities:
          - type: section
            label: SystemhÃ¤lsa
          - entity: binary_sensor.svotc_inputs_healthy
            name: Temperatursensorer OK
            icon: mdi:thermometer-check
          - entity: binary_sensor.svotc_price_available
            name: Prisdata tillgÃ¤nglig
            icon: mdi:cash-check
          - type: section
            label: Timing
          - entity: sensor.svotc_minutes_to_next_brake_start
            name: Minuter till nÃ¤sta dyr period
            icon: mdi:timer-outline
          - entity: sensor.svotc_prebrake_window_min
            name: FÃ¶rbromsfÃ¶nster (min)
            icon: mdi:window-open
          - type: section
            label: Prisstatus (flÃ¶de)
          - entity: sensor.svotc_raw_price_state
            name: RÃ¥prisstatus (direkt)
            icon: mdi:flash
    column_span: 1
  - type: grid
    cards:
      - type: markdown
        title: ğŸ“‹ System Status
        content: >
          ### ğŸ“Š SVOTC StatusÃ¶versikt


          #### ğŸ® Systemstatus

          **DriftslÃ¤ge:** `{{ states('input_select.svotc_mode') }}`  

          **Strategi:** `{{ states('input_text.svotc_reason_code') }}`  

          **SystemhÃ¤lsa:** {% if is_state('binary_sensor.svotc_inputs_healthy',
          'on') %}âœ… OK{% else %}âš ï¸ PROBLEM{% endif %} | **Prisdata:** {% if
          is_state('binary_sensor.svotc_price_available', 'on') %}âœ… OK{% else
          %}âš ï¸ SAKNAS{% endif %}


          ---


          #### ğŸŒ¡ï¸ Temperaturer

          | Sensor | VÃ¤rde | Status |

          |--------|-------|--------|

          | ğŸ  Inne | **{{ states('sensor.svotc_src_indoor') }}Â°C** | MÃ¥l: {{
          states('sensor.svotc_dynamic_target_temperature') }}Â°C |

          | ğŸŒ¡ï¸ Ute (verklig) | **{{ states('sensor.svotc_src_outdoor') }}Â°C** |
          â€” |

          | ğŸ¯ Virtuell (â†’VP) | **{{
          states('sensor.svotc_virtual_outdoor_temperature') }}Â°C** | Offset: {{
          states('input_number.svotc_applied_offset_c') }}Â°C |


          **Offsetstatus:**  

          {% set req = states('input_number.svotc_requested_offset_c') |
          float(0) %}

          {% set app = states('input_number.svotc_applied_offset_c') | float(0)
          %}

          {% set delta = req - app %}

          - BegÃ¤rd: **{{ req }}Â°C** | TillÃ¤mpad: **{{ app }}Â°C** {% if delta |
          abs > 0.05 %}| ğŸ”„ Rampar: {{ delta | round(2) }}Â°C{% endif %}


          ---


          #### ğŸ’° Prisstyrning

          **Aktuellt pris:** {{ states('sensor.svotc_current_price') }}
          SEK/kWh  

          **ReferensvÃ¤rden:** P30 (billig) {{ states('sensor.svotc_p30') }} |
          P80 (dyr) {{ states('sensor.svotc_p80') }}


          {% set price_state = states('input_text.svotc_last_price_state') %}

          {% set raw = states('sensor.svotc_raw_price_state') %}

          **Prisstatus:** 

          {% if price_state == 'cheap' %}ğŸŸ¢ Billig

          {% elif price_state == 'brake' %}ğŸ”´ Dyr

          {% elif price_state == 'off' %}âš« Av

          {% else %}ğŸŸ¡ Neutral

          {% endif %} (stabil: `{{ price_state }}` | rÃ¥: `{{ raw }}`)


          {% set ttn = states('sensor.svotc_minutes_to_next_brake_start') |
          float(999) %}

          {% set win = states('sensor.svotc_prebrake_window_min') | float(0) %}

          {% set pre = states('sensor.svotc_prebrake_strength') | float(0) %}

          {% set starts_in = (ttn - win) if (ttn < 900 and win > 0) else none %}


          **Prebrake-status:**

          {% if win <= 0 %}

          - âšª Inaktiv (fÃ¶nster avstÃ¤ngt)

          {% elif ttn == 0 %}

          - ğŸ”´ I dyrperiod nu (ttn=0)

          {% elif pre > 0 %}

          - ğŸŸ¡ AKTIV ({{ (pre * 100) | round(0) }}% styrka)

          - â±ï¸ Dyrperiod om: {{ ttn | round(0) }} min

          {% elif starts_in is not none and starts_in > 0 %}

          - ğŸŸ¢ VÃ¤ntar (startar om {{ starts_in | round(0) }} min)

          - ğŸ“Š FÃ¶nster: {{ win }} min

          {% else %}

          - â±ï¸ NÃ¤sta dyrperiod om: {{ ttn | round(0) if ttn < 900 else 'â€”' }}
          min

          {% endif %}


          ---


          #### ğŸ›¡ï¸ Komfortskydd

          {% set guard_on =
          is_state('binary_sensor.svotc_comfort_guard_active','on') %}

          {% set guard_enabled =
          is_state('input_boolean.svotc_comfort_guard_enabled','on') %}

          {% set target = states('sensor.svotc_dynamic_target_temperature') |
          float(0) %}

          {% set indoor = states('sensor.svotc_src_indoor') | float(0) %}

          {% set act =
          states('input_number.svotc_comfort_guard_activate_below_c') | float(0)
          %}

          {% set deact =
          states('input_number.svotc_comfort_guard_deactivate_above_c') |
          float(0) %}

          {% set ignite_at = (target - act) | round(2) %}

          {% set release_at = (target - deact) | round(2) %}


          **Status:** {% if not guard_enabled %}ğŸ”´ AVSTÃ„NGD (switch off){% elif
          guard_on %}ğŸŸ¢ AKTIV{% else %}âšª Standby{% endif %}


          {% if guard_enabled %}

          **TrÃ¶sklar:**

          - ğŸ”¥ Aktiveras: inne < **{{ ignite_at }}Â°C** ({{ target }}Â°C âˆ’ {{ act
          }}Â°C)

          - â„ï¸ SlÃ¤pper: inne â‰¥ **{{ release_at }}Â°C** ({{ target }}Â°C âˆ’ {{ deact
          }}Â°C)

          - ğŸ“ Inne nu: **{{ indoor }}Â°C** ({{ (indoor - ignite_at) | round(2)
          }}Â°C frÃ¥n aktivering)

          {% endif %}


          ---


          #### ğŸ”„ Bromsfas

          {% set phase = states('input_text.svotc_brake_phase') %}

          {% set phase_ts =
          as_timestamp(states('input_datetime.svotc_brake_phase_changed'),
          default=none) %}

          {% set phase_age = ((as_timestamp(now()) - phase_ts) / 60) if phase_ts
          is number else none %}

          {% set rampup = states('input_number.svotc_brake_rampup_duration_min')
          | float(0) %}

          {% set hold = states('input_number.svotc_brake_hold_duration_min') |
          float(0) %}

          {% set rampdown =
          states('input_number.svotc_brake_rampdown_duration_min') | float(0) %}


          **Aktuell fas:** 

          {% if phase == 'idle' %}âšª Vilar

          {% elif phase == 'ramping_up' %}ğŸŸ¡ Rampar upp{% if phase_age is not
          none %} ({{ phase_age | round(1) }}/{{ rampup }} min){% endif %}

          {% elif phase == 'holding' %}ğŸ”´ HÃ¥ller{% if phase_age is not none %}
          ({{ phase_age | round(1) }}/{{ hold }} min){% endif %}

          {% elif phase == 'ramping_down' %}ğŸŸ¢ Rampar ner{% if phase_age is not
          none %} ({{ phase_age | round(1) }}/{{ rampdown }} min){% endif %}

          {% else %}â“ {{ phase }}

          {% endif %}


          ---


          #### ğŸ§® Diagnostik


          {% set reason = states('input_text.svotc_reason_code') %}

          {% set p = states('sensor.svotc_current_price') | float(none) %}

          {% set p80 = states('sensor.svotc_p80') | float(none) %}

          {% set brake_active = (app | abs > 0.1 and reason in
          ['PRICE_BRAKE','MCP_BLOCKS_BRAKE']) or pre > 0 %}


          <details>

          <summary><b>ğŸ” VarfÃ¶r denna strategi?</b></summary>


          **Reason: {{ reason }}**


          {% if reason == 'PRICE_BRAKE' %}

          ğŸ’¡ **Bromsar vÃ¤rme** pga dyr el eller fÃ¶rberedelse (prebrake)

          - Pris: {{ p }} SEK/kWh (P80: {{ p80 }})

          - Prebrake: {{ (pre * 100) | round(0) }}%

          - Fas: {{ phase }}

          - Offset: {{ app }}Â°C (minskar vÃ¤rme till VP)


          {% elif reason == 'COMFORT_GUARD' %}

          ğŸ’¡ **Skyddar komfort** - innetemperatur fÃ¶r lÃ¥g

          - Inne: {{ indoor }}Â°C (under {{ ignite_at }}Â°C)

          - Extra vÃ¤rme: {{ app }}Â°C (negativ offset)


          {% elif reason == 'MCP_BLOCKS_BRAKE' %}

          ğŸ’¡ **Konflikt:** BÃ¥de dyr el OCH lÃ¥g innetemperatur

          - Komfortskydd prioriteras â†’ extra vÃ¤rme ges

          - Bromsen blockeras (ingen prisstyrd reduktion)


          {% elif reason == 'NEUTRAL' %}

          ğŸ’¡ **Normal drift**

          - Pris i normallÃ¤ge

          - Komfortskydd ej aktivt

          - Ingen justering behÃ¶vs


          {% elif reason == 'OFF' %}

          âš« **Systemet Ã¤r avstÃ¤ngt**


          {% elif reason == 'PASS_THROUGH' %}

          ğŸ“Š **Ã–vervakningslÃ¤ge** - ingen styrning


          {% elif reason == 'COMFORT_ONLY' %}

          ğŸ›¡ï¸ **Endast komfortskydd** - prisstyrning avstÃ¤ngd


          {% elif reason == 'MISSING_INPUTS_FREEZE' %}

          âš ï¸ **Sensorer saknas** - offset fryst vid senaste vÃ¤rde


          {% elif reason == 'PRICE_DATA_WARMUP_FREEZE' %}

          â³ **Prisdata ej redo** - vÃ¤ntar pÃ¥ komplett data


          {% else %}

          â“ OkÃ¤nd strategi: {{ reason }}

          {% endif %}


          **Intern berÃ¤kning:**

          - `comfort_term` = {% if guard_on %}{{
          -(states('input_number.svotc_heat_aggressiveness') | int(2) * 0.4) |
          round(2) }}{% else %}0{% endif %} (guard {% if guard_on %}aktiv{% else
          %}ej aktiv{% endif %})

          - `price_term` = {% if guard_on %}0 (blockerad){% else %}{{
          (states('input_number.svotc_brake_hold_offset_c') | float(6) *
          states('input_number.svotc_learned_brake_efficiency') | float(1.0) *
          pre) | round(2) }}{% endif %} (hold_offset Ã— efficiency Ã— prebrake)

          - `requested` = {{ req }}Â°C (summa, clamped)

          - `applied` = {{ app }}Â°C (rate-limited)


          </details>


          <details>

          <summary><b>ğŸ“ˆ InlÃ¤rningsstatus</b></summary>


          **Learned brake efficiency:** {{
          states('input_number.svotc_learned_brake_efficiency') }} (0.5-1.5)  

          **Comfort violations (24h):** {{
          states('input_number.svotc_comfort_violations_24h') }}  

          **Thermal mass factor:** {{
          states('input_number.svotc_thermal_mass_factor') }}


          {% set eff = states('input_number.svotc_learned_brake_efficiency') |
          float(1.0) %}

          {% if eff < 0.9 %}

          ğŸ“‰ Systemet har minskat bromsstyrka pga fÃ¶r mÃ¥nga komfortÃ¶vertrÃ¤delser

          {% elif eff > 1.1 %}

          ğŸ“ˆ Systemet har Ã¶kat bromsstyrka - kan bromsa mer aggressivt

          {% else %}

          âœ… Systemet kÃ¶r i optimal balans

          {% endif %}


          </details>


          ---


          #### ğŸ“– Strategi-fÃ¶rklaring


          | Kod | Betydelse |

          |-----|-----------|

          | `PRICE_BRAKE` | ğŸ”´ Bromsar vÃ¤rme vid dyr el / prebrake (positiv
          offset) |

          | `COMFORT_GUARD` | ğŸ”¥ Skyddar komfort (negativ offset = mer vÃ¤rme) |

          | `MCP_BLOCKS_BRAKE` | ğŸ›¡ï¸ Komfortskydd stoppar broms |

          | `NEUTRAL` | ğŸŸ¢ Normal drift, ingen justering |

          | `OFF` | âš« System avstÃ¤ngt |

          | `PASS_THROUGH` | ğŸ“Š Ã–vervakningslÃ¤ge |

          | `COMFORT_ONLY` | ğŸ›¡ï¸ Endast komfortskydd |

          | `MISSING_INPUTS_FREEZE` | âš ï¸ Sensorer saknas |

          | `PRICE_DATA_WARMUP_FREEZE` | â³ Prisdata initieras |


          ---


          <details>

          <summary><i>ğŸ”§ Teknisk data (klicka fÃ¶r att visa)</i></summary>


          **Raw state data:**

          - `raw_price_state`: {{ raw }}

          - `stable_price_state`: {{ price_state }}

          - `pending_price_state`: {{
          states('input_text.svotc_pending_price_state') }}

          - `brake_phase`: {{ phase }}

          - `prebrake_strength`: {{ (pre * 100) | round(1) }}%

          - `prebrake_window`: {{ win }} min


          **Timestamps:**

          - Price state changed: {{
          states('input_datetime.svotc_last_price_state_changed') }}

          - Brake phase changed: {{
          states('input_datetime.svotc_brake_phase_changed') }}

          - Engine last run: {{ states('input_datetime.svotc_engine_last_run')
          }}


          **Entities:**

          - Indoor: `{{ states('input_text.svotc_entity_indoor') }}`

          - Outdoor: `{{ states('input_text.svotc_entity_outdoor') }}`

          - Price: `{{ states('input_text.svotc_entity_price') }}`


          </details>


          ---


          *Uppdaterad: {{ now().strftime('%Y-%m-%d %H:%M:%S') }}*
max_columns: 4
