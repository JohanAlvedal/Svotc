###############################################################################
# SVOTC – Full Rebuild Edition
# Optimerad för: Bergvärme
# Styrstrategi: Offset-styrning
# Profil: Balanserad (komfort + pris)
###############################################################################

###############################################################################
# 1. UI / Controls
###############################################################################

input_select:
  svotc_mode:
    name: "SVOTC Mode"
    options:
      - "Off"
      - "Smart"
      - "ComfortOnly"
      - "PassThrough"

input_number:
  # -----------------------------
  # Komfortinställningar
  # -----------------------------
  svotc_comfort_temperature:
    name: "Comfort temperature"
    min: 15
    max: 25
    step: 0.1
    mode: box

  svotc_comfort_guard_activate_below_c:
    name: "Comfort guard activate (below target)"
    min: 0.2
    max: 3.0
    step: 0.1
    mode: box
    initial: 1.0   # IVT Geo: större tröghet → större hysteres

  svotc_comfort_guard_deactivate_above_c:
    name: "Comfort guard deactivate (above target)"
    min: 0.1
    max: 2.0
    step: 0.1
    mode: box
    initial: 0.4

  # -----------------------------
  # Offset Engine
  # -----------------------------
  svotc_requested_offset_c:
    name: "Requested offset (raw)"
    min: -10
    max: 10
    step: 0.1
    mode: box

  svotc_applied_offset_c:
    name: "Applied offset (smoothed)"
    min: -10
    max: 10
    step: 0.1
    mode: box

  svotc_max_delta_per_step_c:
    name: "Max delta per minute"
    min: 0.05
    max: 1.0
    step: 0.01
    mode: box
    initial: 0.20   # IVT Geo: mjuk rampning

  # -----------------------------
  # Prislogik
  # -----------------------------
  svotc_brake_aggressiveness:
    name: "Brake aggressiveness"
    min: 0
    max: 5
    step: 1
    mode: slider
    initial: 3

  svotc_heat_aggressiveness:
    name: "Heat aggressiveness"
    min: 0
    max: 5
    step: 1
    mode: slider
    initial: 3

  svotc_price_dwell_cheap_to_neutral_min:
    name: "Dwell cheap → neutral"
    min: 5
    max: 120
    step: 5
    mode: box
    initial: 20

  svotc_price_dwell_neutral_to_brake_min:
    name: "Dwell neutral → brake"
    min: 5
    max: 120
    step: 5
    mode: box
    initial: 30

  svotc_price_dwell_brake_to_neutral_min:
    name: "Dwell brake → neutral"
    min: 5
    max: 120
    step: 5
    mode: box
    initial: 15

  svotc_price_dwell_neutral_to_cheap_min:
    name: "Dwell neutral → cheap"
    min: 5
    max: 120
    step: 5
    mode: box
    initial: 10

  # -----------------------------
  # Brake-faser
  # -----------------------------
  svotc_brake_rampup_duration_min:
    name: "Brake ramp-up duration"
    min: 5
    max: 120
    step: 5
    initial: 30

  svotc_brake_hold_duration_min:
    name: "Brake hold duration"
    min: 10
    max: 300
    step: 10
    initial: 60

  svotc_brake_rampdown_duration_min:
    name: "Brake ramp-down duration"
    min: 5
    max: 120
    step: 5
    initial: 45

  svotc_brake_hold_offset_c:
    name: "Brake hold offset"
    min: 0
    max: 10
    step: 0.1
    mode: box

  # -----------------------------
  # Statistik
  # -----------------------------
  svotc_total_offset_hours_today:
    name: "Offset hours today"
    min: 0
    max: 24
    step: 0.01
    mode: box

  svotc_max_offset_hours_per_day:
    name: "Max offset hours per day"
    min: 0
    max: 24
    step: 1
    initial: 18

input_text:
  svotc_entity_indoor:
    name: "Indoor temperature entity"
    initial: "sensor.inomhusmedel"

  svotc_entity_outdoor:
    name: "Outdoor temperature entity"
    initial: "sensor.temperatur_nu"
    # Ändra till din elpris-sensor
    # Måste ha attributes: current_price, raw_today, raw_tomorrow
    # Kompatibel med Nordpool/Tibber HACS-integrationen
    
  svotc_entity_price:
    name: "Price entity"
    initial: "sensor.nordpool_tibber"
    
#   svotc_entity_price_today:
#     name: "SVOTC Entity: Price today (official Nordpool)"
#     initial: "sensor.today_price"

#   svotc_entity_price_tomorrow:
#     name: "SVOTC Entity: Price tomorrow (official Nordpool)"
#     initial: "sensor.tomorrow_price"

#   svotc_entity_price_current:
#     name: "SVOTC Entity: Price current (official Nordpool)"
#     initial: "sensor.current_price"

  svotc_notifier:
    name: "Notifier service"
    initial: "notify.notify"

  svotc_reason_code:
    name: "Reason code"

  svotc_last_price_state:
    name: "Last price state"

  svotc_pending_price_state:
    name: "Pending price state"

  svotc_brake_phase:
    name: "Brake phase"
    initial: "idle"

input_datetime:
  svotc_last_price_state_changed:
    name: "Last price state changed"
    has_date: true
    has_time: true

  svotc_brake_phase_changed:
    name: "Brake phase changed"
    has_date: true
    has_time: true

  svotc_offset_hours_reset:
    name: "Offset hours reset"
    has_date: true
    has_time: true

input_boolean:
  svotc_missing_inputs_alerted:
    name: "Missing inputs alerted"

  svotc_fail_safe_active:
    name: "Fail-safe active"

###############################################################################
# 2. CORE SENSORS (Indoor, Outdoor, Price)
###############################################################################

template:
  - sensor:
      #########################################################################
      # 2.1 Indoor temperature (validated)
      #########################################################################
      - name: "SVOTC Src Indoor"
        unique_id: svotc_src_indoor
        unit_of_measurement: "°C"
        device_class: temperature
        state_class: measurement
        state: >
          {% set ent = states('input_text.svotc_entity_indoor') %}
          {% set ent = ent if ent not in ['unknown','unavailable',''] else 'sensor.inomhusmedel' %}
          {% set val = states(ent) | float(none) %}
          {# IVT Geo: normal indoor range 15–30°C #}
          {% if val is number and 15 <= val <= 30 %}
            {{ val | round(2) }}
          {% else %}
            {{ this.state if this.state | is_number else none }}
          {% endif %}
        availability: >
          {% set ent = states('input_text.svotc_entity_indoor') %}
          {% set ent = ent if ent not in ['unknown','unavailable',''] else 'sensor.inomhusmedel' %}
          {% set val = states(ent) | float(none) %}
          {{ val is number and 15 <= val <= 30 }}

      #########################################################################
      # 2.2 Outdoor temperature (validated, IVT Geo optimized)
      #########################################################################
      - name: "SVOTC Src Outdoor"
        unique_id: svotc_src_outdoor
        unit_of_measurement: "°C"
        device_class: temperature
        state_class: measurement
        state: >
          {% set ent = states('input_text.svotc_entity_outdoor') %}
          {% set ent = ent if ent not in ['unknown','unavailable',''] else 'sensor.temperatur_nu' %}
          {% set val = states(ent) | float(none) %}
          {# IVT Geo: normal outdoor range -40 to +35°C #}
          {% if val is number and -40 <= val <= 35 %}
            {{ val | round(2) }}
          {% else %}
            {{ this.state if this.state | is_number else none }}
          {% endif %}
        availability: >
          {% set ent = states('input_text.svotc_entity_outdoor') %}
          {% set ent = ent if ent not in ['unknown','unavailable',''] else 'sensor.temperatur_nu' %}
          {% set val = states(ent) | float(none) %}
          {{ val is number and -40 <= val <= 35 }}

      #########################################################################
      # 2.3 Price sensor (validated)
      #########################################################################
      - name: "SVOTC Src Current Price"
        unique_id: svotc_src_current_price
        unit_of_measurement: "SEK/kWh"
        state: >
          {% set ent = states('input_text.svotc_entity_price') %}
          {% set ent = ent if ent not in ['unknown','unavailable',''] else 'sensor.nordpool_tibber' %}
          {% set p = state_attr(ent, 'current_price') %}
          {# Normal price range 0–10 SEK/kWh #}
          {% if p is number and 0 <= p <= 10 %}
            {{ p | round(3) }}
          {% else %}
            {{ this.state if this.state | is_number else none }}
          {% endif %}
        availability: >
          {% set ent = states('input_text.svotc_entity_price') %}
          {% set ent = ent if ent not in ['unknown','unavailable',''] else 'sensor.nordpool_tibber' %}
          {% set p = state_attr(ent, 'current_price') %}
          {{ p is number and 0 <= p <= 10 }}

      #########################################################################
      # 2.4 Dynamic target temperature
      #########################################################################
      - name: "SVOTC Dynamic target temperature"
        unique_id: svotc_dynamic_target_temperature
        unit_of_measurement: "°C"
        device_class: temperature
        state: >
          {{ states('input_number.svotc_comfort_temperature') | float(21) }}

      #########################################################################
      # 2.5 Percentiles (P30, P70, P80)
      #########################################################################
      - name: "SVOTC P30"
        unique_id: svotc_p30
        unit_of_measurement: "SEK/kWh"
        state: >
          {% set ent = states('input_text.svotc_entity_price') %}
          {% set ent = ent if ent not in ['unknown','unavailable',''] else 'sensor.nordpool_tibber' %}
          {% set today = state_attr(ent, 'raw_today') | default([], true) %}
          {% set tomorrow = state_attr(ent, 'raw_tomorrow') | default([], true) %}
          {% set prices = (today + tomorrow) | map(attribute='value') | select('number') | list %}
          {% if prices | length >= 20 %}
            {% set s = prices | sort %}
            {% set idx = ((s | length - 1) * 0.30) | round(0, 'half_up') | int %}
            {{ s[idx] | round(3) }}
          {% else %}
            {{ none }}
          {% endif %}

      - name: "SVOTC P70"
        unique_id: svotc_p70
        unit_of_measurement: "SEK/kWh"
        state: >
          {% set ent = states('input_text.svotc_entity_price') %}
          {% set ent = ent if ent not in ['unknown','unavailable',''] else 'sensor.nordpool_tibber' %}
          {% set today = state_attr(ent, 'raw_today') | default([], true) %}
          {% set tomorrow = state_attr(ent, 'raw_tomorrow') | default([], true) %}
          {% set prices = (today + tomorrow) | map(attribute='value') | select('number') | list %}
          {% if prices | length >= 20 %}
            {% set s = prices | sort %}
            {% set idx = ((s | length - 1) * 0.70) | round(0, 'half_up') | int %}
            {{ s[idx] | round(3) }}
          {% else %}
            {{ this.state if this.state | is_number else none }}
          {% endif %}

      - name: "SVOTC P80"
        unique_id: svotc_p80
        unit_of_measurement: "SEK/kWh"
        state: >
          {% set ent = states('input_text.svotc_entity_price') %}
          {% set ent = ent if ent not in ['unknown','unavailable',''] else 'sensor.nordpool_tibber' %}
          {% set today = state_attr(ent, 'raw_today') | default([], true) %}
          {% set tomorrow = state_attr(ent, 'raw_tomorrow') | default([], true) %}
          {% set prices = (today + tomorrow) | map(attribute='value') | select('number') | list %}
          {% if prices | length >= 20 %}
            {% set s = prices | sort %}
            {% set idx = ((s | length - 1) * 0.80) | round(0, 'half_up') | int %}
            {{ s[idx] | round(3) }}
          {% else %}
            {{ this.state if this.state | is_number else none }}
          {% endif %}

      #########################################################################
      # 2.6 Current price + raw price state
      #########################################################################
      - name: "SVOTC Current price"
        unique_id: svotc_current_price
        unit_of_measurement: "SEK/kWh"
        state: "{{ states('sensor.svotc_src_current_price') | float(none) }}"

      - name: "SVOTC Raw price state"
        unique_id: svotc_raw_price_state
        state: >
          {% set mode = states('input_select.svotc_mode') %}
          {% if mode in ['Off', 'PassThrough', 'ComfortOnly'] %}
            off
          {% else %}
            {% set p = states('sensor.svotc_src_current_price') | float(none) %}
            {% set p30 = states('sensor.svotc_p30') | float(none) %}
            {% set p80 = states('sensor.svotc_p80') | float(none) %}
            {% if p is number and p80 is number and p > p80 %}
              brake
            {% elif p is number and p30 is number and p < p30 %}
              cheap
            {% else %}
              neutral
            {% endif %}
          {% endif %}

      #########################################################################
      # 3. PRICE LOGIC (Dwell, Brake State, Pre-Brake)
      #########################################################################

      #########################################################################
      # 3.1 Minutes to next brake start (based on P80)
      #########################################################################
      - name: "SVOTC Minutes to next brake start"
        unique_id: svotc_minutes_to_next_brake_start
        unit_of_measurement: "min"
        state: >
          {% set ent = states('input_text.svotc_entity_price') %}
          {% set ent = ent if ent not in ['unknown','unavailable',''] else 'sensor.nordpool_tibber' %}
          {% set today = state_attr(ent, 'raw_today') | default([], true) %}
          {% set tomorrow = state_attr(ent, 'raw_tomorrow') | default([], true) %}
          {% set combined = today + tomorrow %}
          {% set p80 = states('sensor.svotc_p80') | float(none) %}
          {% set now_ts = as_timestamp(now()) %}
          {% set ns = namespace(best=none) %}
          {% if p80 is number %}
            {% for it in combined %}
              {% set v = it.value | float(none) %}
              {% set ts = as_timestamp(it.start, default=none) if it.start is defined else none %}
              {% if v is number and ts is number and ts >= now_ts and v > p80 %}
                {% set mins = (ts - now_ts) / 60 %}
                {% if ns.best is none or mins < ns.best %}
                  {% set ns.best = mins %}
                {% endif %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {{ ns.best | round(1) if ns.best is not none else 999 }}

      #########################################################################
      # 3.2 Pre-brake window (based on aggressiveness)
      #########################################################################
      - name: "SVOTC Prebrake window (min)"
        unique_id: svotc_prebrake_window_min
        unit_of_measurement: "min"
        state: >
          {% set a = states('input_number.svotc_brake_aggressiveness') | int(0) %}
          {% set mapper = {0:0, 1:30, 2:60, 3:90, 4:105, 5:120} %}
          {{ mapper.get(a, 0) }}

      #########################################################################
      # 3.3 Pre-brake strength (0–1)
      #########################################################################
      - name: "SVOTC Prebrake strength"
        unique_id: svotc_prebrake_strength
        state: >
          {% set window = states('sensor.svotc_prebrake_window_min') | float(0) %}
          {% set mins = states('sensor.svotc_minutes_to_next_brake_start') | float(999) %}
          {% if window > 0 and mins <= window %}
            {{ ((window - mins) / window) | round(3) | clamp(0, 1) }}
          {% else %}
            0
          {% endif %}

      #########################################################################
      # 3.4 Brake phase progress (0–100%)
      #########################################################################
      - name: "SVOTC Brake phase progress"
        unique_id: svotc_brake_phase_progress
        unit_of_measurement: "%"
        state: >
          {% set phase = states('input_text.svotc_brake_phase') %}
          {% if phase == 'idle' %}
            0
          {% else %}
            {% set changed_ts = as_timestamp(states('input_datetime.svotc_brake_phase_changed'), default=none) %}
            {% if changed_ts is number %}
              {% set elapsed = (as_timestamp(now()) - changed_ts) / 60 %}
              {% set duration =
                states('input_number.svotc_brake_rampup_duration_min') | float(30) if phase == 'ramping_up'
                else states('input_number.svotc_brake_hold_duration_min') | float(60) if phase == 'holding'
                else states('input_number.svotc_brake_rampdown_duration_min') | float(45) if phase == 'ramping_down'
                else 1 %}
              {{ ((elapsed / duration * 100) | round(1)) | clamp(0, 100) }}
            {% else %}
              0
            {% endif %}
          {% endif %}

      #########################################################################
      # 4. COMFORT LOGIC (Target, Guard, MCP)
      #########################################################################

      #########################################################################
      # 4.1 Comfort guard (stabil hysteres, IVT-optimerad)
      #########################################################################
      - name: "SVOTC Comfort guard active"
        unique_id: svotc_comfort_guard_active
        state: >
          {% set indoor = states('sensor.svotc_src_indoor') | float(none) %}
          {% set target = states('sensor.svotc_dynamic_target_temperature') | float(none) %}
          {% set activate_below = states('input_number.svotc_comfort_guard_activate_below_c') | float(1.0) %}
          {% set deactivate_above = states('input_number.svotc_comfort_guard_deactivate_above_c') | float(0.4) %}
          {% set was_on = is_state('binary_sensor.svotc_comfort_guard_active','on') %}
          {% if indoor is not number or target is not number %}
            {{ was_on }}
          {% else %}
            {% set activate_threshold = target - activate_below %}
            {% set deactivate_threshold = target - deactivate_above %}
            {% if was_on %}
              {{ indoor < deactivate_threshold }}
            {% else %}
              {{ indoor < activate_threshold }}
            {% endif %}
          {% endif %}

      #########################################################################
      # 4.2 Comfort deviation (hur långt från target)
      #########################################################################
      - name: "SVOTC Comfort deviation"
        unique_id: svotc_comfort_deviation
        unit_of_measurement: "°C"
        state: >
          {% set indoor = states('sensor.svotc_src_indoor') | float(none) %}
          {% set target = states('sensor.svotc_dynamic_target_temperature') | float(none) %}
          {% if indoor is number and target is number %}
            {{ (indoor - target) | round(2) }}
          {% else %}
            0
          {% endif %}

      #########################################################################
      # 4.3 MCP (Minimum Comfort Protection)
      #     Ger extra värme när det är kallt inne, men mjukt.
      #########################################################################
      - name: "SVOTC MCP offset"
        unique_id: svotc_mcp_offset
        unit_of_measurement: "°C"
        state: >
          {% set dev = states('sensor.svotc_comfort_deviation') | float(0) %}
          {% set guard = is_state('binary_sensor.svotc_comfort_guard_active','on') %}
          {% set heat = states('input_number.svotc_heat_aggressiveness') | int(0) %}
          {% if guard %}
            {# IVT Geo: mjuk MCP, max 2°C #}
            {% set boost = (heat * 0.4) %}
            {{ boost | round(2) }}
          {% else %}
            0
          {% endif %}

      #########################################################################
      # 4.4 Combined comfort offset (MCP + pre-brake)
      #########################################################################
      - name: "SVOTC Comfort combined offset"
        unique_id: svotc_comfort_combined_offset
        unit_of_measurement: "°C"
        state: >
          {% set mcp = states('sensor.svotc_mcp_offset') | float(0) %}
          {% set pre = states('sensor.svotc_prebrake_strength') | float(0) %}
          {% set brake_aggr = states('input_number.svotc_brake_aggressiveness') | int(0) %}
          {# Pre-brake ger mjuk offset innan dyrperiod #}
          {% set pre_offset = pre * (brake_aggr * 0.6) %}
          {{ (mcp + pre_offset) | round(2) }}

      #########################################################################
      # 5. OFFSET ENGINE (Rate-limit + Smoothing + Applied Offset)
      #########################################################################

      #########################################################################
      # 5.1 Rate-limited offset
      #     Begränsar hur snabbt offset får ändras per minut.
      #     Detta är den viktigaste delen för att undvika dippar.
      #########################################################################
      - name: "SVOTC Rate-limited offset"
        unique_id: svotc_rate_limited_offset
        unit_of_measurement: "°C"
        state: >
          {% set req = states('input_number.svotc_requested_offset_c') | float(0) %}
          {% set prev = this.state | float(req) %}
          {% set max_delta = states('input_number.svotc_max_delta_per_step_c') | float(0.2) %}
          {% set delta = req - prev %}
          {% if delta > max_delta %}
            {{ (prev + max_delta) | round(2) }}
          {% elif delta < -max_delta %}
            {{ (prev - max_delta) | round(2) }}
          {% else %}
            {{ req | round(2) }}
          {% endif %}

      #########################################################################
      # 5.2 Smoothed offset (low-pass filter)
      #     Tar bort 80–90% av alla hack och gör kurvan helt mjuk.
      #########################################################################
      - name: "SVOTC Smoothed offset"
        unique_id: svotc_smoothed_offset
        unit_of_measurement: "°C"
        state: >
          {% set raw = states('sensor.svotc_rate_limited_offset') | float(0) %}
          {% set prev = this.state | float(raw) %}
          {{ (prev * 0.8 + raw * 0.2) | round(2) }}

      #########################################################################
      # 5.3 Debug: Offset delta (för felsökning)
      #########################################################################
      - name: "SVOTC Offset delta"
        unique_id: svotc_offset_delta
        unit_of_measurement: "°C"
        state: >
          {% set req = states('input_number.svotc_requested_offset_c') | float(0) %}
          {% set app = states('sensor.svotc_smoothed_offset') | float(0) %}
          {{ (req - app) | round(2) }}

      #########################################################################
      # 5.4 Debug: Offset engine mode
      #########################################################################
      - name: "SVOTC Offset engine mode"
        unique_id: svotc_offset_engine_mode
        state: >
          {% set delta = states('sensor.svotc_offset_delta') | float(0) %}
          {% if delta > 0.05 %}
            ramping_up
          {% elif delta < -0.05 %}
            ramping_down
          {% else %}
            stable
          {% endif %}

      #########################################################################
      # 6. VIRTUAL OUTDOOR (Smooth, Stable, IVT-Optimized)
      #########################################################################

      #########################################################################
      # 6.1 Virtual outdoor temperature (uses smoothed offset)
      #########################################################################
      - name: "SVOTC Virtual outdoor temperature"
        unique_id: svotc_virtual_outdoor_temperature
        unit_of_measurement: "°C"
        device_class: temperature
        state: >
          {% set out = states('sensor.svotc_src_outdoor') | float(none) %}
          {% set off = states('sensor.svotc_smoothed_offset') | float(0) %}
          {% if out is number %}
            {# IVT Geo: säkra clamp-gränser #}
            {{ (out + off) | clamp(-30, 30) | round(2) }}
          {% else %}
            {{ this.state }}
          {% endif %}

      #########################################################################
      # 6.2 Debug: Virtual outdoor components
      #########################################################################
      - name: "SVOTC Virtual outdoor components"
        unique_id: svotc_virtual_outdoor_components
        state: >
          {{ "out=" ~ states('sensor.svotc_src_outdoor') ~
             ", off=" ~ states('sensor.svotc_smoothed_offset') }}

  - binary_sensor:
      #########################################################################
      # Binary sensors for system health
      #########################################################################
      - name: "SVOTC All sensors healthy"
        unique_id: svotc_all_sensors_healthy
        state: >
          {{ is_state('sensor.svotc_src_indoor', 'unavailable') == false
             and is_state('sensor.svotc_src_outdoor', 'unavailable') == false
             and is_state('sensor.svotc_src_current_price', 'unavailable') == false }}

###############################################################################
# 7. AUTOMATIONS (Price dwell, Brake phases, Fail-safe, Reason codes)
###############################################################################

automation:
  ###########################################################################
  # 7.1 Price dwell state machine
  ###########################################################################
  - alias: "SVOTC Price dwell"
    id: svotc_price_dwell
    trigger:
      - platform: time_pattern
        minutes: "/1"
      - platform: state
        entity_id: sensor.svotc_raw_price_state
    action:
      - variables:
          raw: "{{ states('sensor.svotc_raw_price_state') }}"
          stable: "{{ states('input_text.svotc_last_price_state') }}"
          pending: "{{ states('input_text.svotc_pending_price_state') }}"
          last_change: "{{ states('input_datetime.svotc_last_price_state_changed') }}"

      # 1. Om raw ändrats → pending uppdateras
      - choose:
          - conditions: "{{ raw != pending }}"
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.svotc_pending_price_state
                data:
                  value: "{{ raw }}"
              - service: input_datetime.set_datetime
                target:
                  entity_id: input_datetime.svotc_last_price_state_changed
                data:
                  datetime: "{{ now() }}"

      # 2. Kontrollera dwell-tider
      - variables:
          elapsed: >
            {% set ts = as_timestamp(states('input_datetime.svotc_last_price_state_changed')) %}
            {% if ts is number %}
              {{ (as_timestamp(now()) - ts) / 60 }}
            {% else %}
              999
            {% endif %}
          dwell_needed: >
            {% set p = pending %}
            {% if stable == 'cheap' and p == 'neutral' %}
              {{ states('input_number.svotc_price_dwell_cheap_to_neutral_min') }}
            {% elif stable == 'neutral' and p == 'brake' %}
              {{ states('input_number.svotc_price_dwell_neutral_to_brake_min') }}
            {% elif stable == 'brake' and p == 'neutral' %}
              {{ states('input_number.svotc_price_dwell_brake_to_neutral_min') }}
            {% elif stable == 'neutral' and p == 'cheap' %}
              {{ states('input_number.svotc_price_dwell_neutral_to_cheap_min') }}
            {% else %}
              0
            {% endif %}

      # 3. Om dwell uppfyllt → stable = pending
      - choose:
          - conditions: "{{ elapsed | float(0) >= dwell_needed | float(0) }}"
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.svotc_last_price_state
                data:
                  value: "{{ pending }}"

  ###########################################################################
  # 7.2 Brake phase controller
  ###########################################################################
  - alias: "SVOTC Brake phase controller"
    id: svotc_brake_phase_controller
    trigger:
      - platform: time_pattern
        minutes: "/1"
      - platform: state
        entity_id: input_text.svotc_last_price_state
    action:
      - variables:
          price_state: "{{ states('input_text.svotc_last_price_state') }}"
          phase: "{{ states('input_text.svotc_brake_phase') }}"
          progress: "{{ states('sensor.svotc_brake_phase_progress') | float(0) }}"

      # 1. Om inte brake → gå till idle
      - choose:
          - conditions: "{{ price_state != 'brake' }}"
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.svotc_brake_phase
                data:
                  value: "idle"
              - service: input_datetime.set_datetime
                target:
                  entity_id: input_datetime.svotc_brake_phase_changed
                data:
                  datetime: "{{ now() }}"
              - stop: true

      # 2. Om brake → hantera faser
      - choose:
          # ramping_up → holding
          - conditions: "{{ phase == 'ramping_up' and progress >= 100 }}"
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.svotc_brake_phase
                data:
                  value: "holding"
              - service: input_datetime.set_datetime
                target:
                  entity_id: input_datetime.svotc_brake_phase_changed
                data:
                  datetime: "{{ now() }}"

          # holding → ramping_down
          - conditions: "{{ phase == 'holding' and progress >= 100 }}"
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.svotc_brake_phase
                data:
                  value: "ramping_down"
              - service: input_datetime.set_datetime
                target:
                  entity_id: input_datetime.svotc_brake_phase_changed
                data:
                  datetime: "{{ now() }}"

          # ramping_down → idle
          - conditions: "{{ phase == 'ramping_down' and progress >= 100 }}"
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.svotc_brake_phase
                data:
                  value: "idle"
              - service: input_datetime.set_datetime
                target:
                  entity_id: input_datetime.svotc_brake_phase_changed
                data:
                  datetime: "{{ now() }}"

      # 3. Start ramping_up om brake och idle
      - choose:
          - conditions: "{{ price_state == 'brake' and phase == 'idle' }}"
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.svotc_brake_phase
                data:
                  value: "ramping_up"
              - service: input_datetime.set_datetime
                target:
                  entity_id: input_datetime.svotc_brake_phase_changed
                data:
                  datetime: "{{ now() }}"

  ###########################################################################
  # 7.3 Fail-safe (sensor health)
  ###########################################################################
  - alias: "SVOTC Fail-safe"
    id: svotc_fail_safe
    trigger:
      - platform: time_pattern
        minutes: "/2"
    action:
      - choose:
          - conditions: "{{ not is_state('binary_sensor.svotc_all_sensors_healthy','on') }}"
            sequence:
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.svotc_fail_safe_active
              - service: input_number.set_value
                target:
                  entity_id: input_number.svotc_applied_offset_c
                data:
                  value: 0
              - stop: true

      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.svotc_fail_safe_active

  ###########################################################################
  # 7.4 Offset hours counter
  ###########################################################################
  - alias: "SVOTC Offset hours counter"
    id: svotc_offset_hours_counter
    trigger:
      - platform: time_pattern
        minutes: "/5"
    action:
      - variables:
          offset_c: "{{ states('input_number.svotc_applied_offset_c') | float(0) }}"
      - choose:
          - conditions: "{{ offset_c > 0.5 }}"
            sequence:
              - service: input_number.set_value
                target:
                  entity_id: input_number.svotc_total_offset_hours_today
                data:
                  value: >
                    {{ (states('input_number.svotc_total_offset_hours_today') | float(0)) + 0.083 }}

  ###########################################################################
  # 7.5 Midnight reset
  ###########################################################################
  - alias: "SVOTC Midnight reset"
    id: svotc_midnight_reset
    trigger:
      - platform: time
        at: "00:00:00"
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.svotc_total_offset_hours_today
        data:
          value: 0

      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.svotc_offset_hours_reset
        data:
          datetime: "{{ now() }}"

  ###########################################################################
  # 7.6 Apply smoothed offset → applied_offset_c
  ###########################################################################
  - alias: "SVOTC Apply smoothed offset"
    id: svotc_apply_smoothed_offset
    trigger:
      - platform: state
        entity_id: sensor.svotc_smoothed_offset
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.svotc_applied_offset_c
        data:
          value: "{{ states('sensor.svotc_smoothed_offset') | float(0) }}"
