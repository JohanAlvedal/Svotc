template:
  - sensor:
      - name: "Ute temperatur (MET)"
        unique_id: outdoor_temp_met
        unit_of_measurement: "Â°C"
        device_class: temperature
        state_class: measurement
        state: >
          {% set t = state_attr('weather.forecast_met_no', 'temperature') %}
          {% if t is number %}
            {{ t | round(1) }}
          {% else %}
            {{ states('sensor.outdoor_temp_met') | float(0) }}
          {% endif %}

  - trigger:
      - platform: time_pattern
        minutes: "/10"
      - platform: homeassistant
        event: start
    action:
      - action: nordpool.get_prices_for_date
        data:
          config_entry: 01KFMT87S3Q0JM0D2V6V4VKDN5
          date: "{{ now().date() + timedelta(days=1) }}"
          areas: SE3
          currency: SEK
        response_variable: tomorrow_price

    sensor:
      - name: Tomorrow price
        unique_id: se3_tomorrow_price

        availability: >
          {% set entries = tomorrow_price.get('SE3', []) %}
          {{ entries | length > 0 }}

        state: >
          {% set entries = tomorrow_price.get('SE3', []) %}
          {% if entries | length == 0 %}
            unavailable
          {% else %}
            {% set ns = namespace(vals=[]) %}
            {% for s in entries %}
              {% set ns.vals = ns.vals + [(s.price / 1000) | float(0)] %}
            {% endfor %}
            {{ ns.vals | min }}
          {% endif %}

        attributes:
          tomorrow_valid: >
            {% set entries = tomorrow_price.get('SE3', []) %}
            {{ entries | length > 0 }}

          data: >
            {% set entries = tomorrow_price.get('SE3', []) %}
            {% set ns = namespace(prices=[]) %}
            {% if entries | length > 0 %}
              {% for s in entries %}
                {% set ns.prices = ns.prices + [{
                  'start': (s.start | as_datetime | as_local).isoformat(),
                  'end': (s.end | as_datetime | as_local).isoformat(),
                  'price': (s.price / 1000)
                }] %}
              {% endfor %}
            {% endif %}
            {{ ns.prices }}

  - trigger:
      - platform: time_pattern
        minutes: "/10"
      - platform: homeassistant
        event: start
    action:
      - action: nordpool.get_prices_for_date
        data:
          config_entry: 01KFMT87S3Q0JM0D2V6V4VKDN5
          date: "{{ now().date() }}"
          areas: SE3
          currency: SEK
        response_variable: today_price

    sensor:
      - name: Today price
        unique_id: se3_today_price
        state: >
          {% set entries = today_price.get('SE3', []) %}
          {% if entries | length == 0 %}
            unavailable
          {% else %}
            {% set data = namespace(prices=[]) %}
            {% for s in entries %}
              {% set data.prices = data.prices + [{
                'start': (s.start | as_datetime | as_local).isoformat(),
                'end':   (s.end   | as_datetime | as_local).isoformat(),
                'price': (s.price / 1000)
              }] %}
            {% endfor %}

            {% set now_ts = now().timestamp() %}
            {% set ns = namespace(v=None) %}
            {% for p in data.prices %}
              {% set st = as_timestamp(p.start) %}
              {% set en = as_timestamp(p.end) %}
              {% if st <= now_ts < en %}
                {% set ns.v = p.price | float(0) %}
                {% break %}
              {% endif %}
            {% endfor %}
            {{ ns.v if ns.v is not none else 'unavailable' }}
          {% endif %}

        attributes:
          min: >
            {% set entries = today_price.get('SE3', []) %}
            {% if entries | length == 0 %}
              unavailable
            {% else %}
              {% set ns = namespace(vals=[]) %}
              {% for s in entries %}
                {% set ns.vals = ns.vals + [(s.price/1000) | float(0)] %}
              {% endfor %}
              {{ (ns.vals | min) if (ns.vals | length > 0) else 'unavailable' }}
            {% endif %}

          data: >
            {% set entries = today_price.get('SE3', []) %}
            {% set data = namespace(prices=[]) %}
            {% if entries | length > 0 %}
              {% for s in entries %}
                {% set data.prices = data.prices + [{
                  'start': (s.start | as_datetime | as_local).isoformat(),
                  'end':   (s.end   | as_datetime | as_local).isoformat(),
                  'price': (s.price/1000)
                }] %}
              {% endfor %}
            {% endif %}
            {{ data.prices }}

  - trigger:
      - platform: time_pattern
        minutes: "/1"
      - platform: homeassistant
        event: start
      - platform: state
        entity_id:
          # Prices
          - sensor.nord_pool_se3_aktuellt_pris
          - sensor.nord_pool_se3_hogsta_pris
          - sensor.nord_pool_se3_lagsta_pris
          - sensor.nord_pool_se3_dagligt_genomsnitt
          - sensor.nord_pool_se3_foregaende_pris
          - sensor.nord_pool_se3_nasta_pris
          # Temp (change if needed)
          - sensor.shelly_uni_temperature_2

    sensor:
      - name: "Elpriskoefficient"
        unique_id: elpriskoefficient_se3
        unit_of_measurement: ""
        state: >
          {% set prev = this.state | float(default=0) %}

          {% set elpris_a = 1.3 | float %}
          {% set elpris_b = -0.7 | float %}
          {% set elpris_c = 0.25 | float %}

          {% set elpris = states('sensor.nord_pool_se3_aktuellt_pris') | float(default=none) %}
          {% set elpris_max = states('sensor.nord_pool_se3_hogsta_pris') | float(default=none) %}
          {% set elpris_min = states('sensor.nord_pool_se3_lagsta_pris') | float(default=none) %}
          {% set elpris_avg = states('sensor.nord_pool_se3_dagligt_genomsnitt') | float(default=none) %}

          {% if elpris is none or elpris_max is none or elpris_min is none or elpris_max <= 0 %}
            {{ prev }}
          {% else %}
            {% if elpris_avg is none %}
              {% set elpris_avg = (elpris_max + elpris_min) / 2 %}
            {% endif %}

            {% set elpris_graens =
                 (elpris_max - elpris_min)
                 * (elpris_a * (elpris_max ** elpris_b))
                 * (1 / (1 + elpris_min * elpris_c))
                 + elpris_min
            %}

            {{ (elpris / elpris_graens) | round(2, default=prev) }}
          {% endif %}

    binary_sensor:
      - name: "Elpris OK"
        unique_id: elpris_ok
        state: >
          {% set k = states('sensor.elpriskoefficient_se3') | float(none) %}
          {% set t = states('sensor.ute_temperatur_met') | float(none) %}
          {{ (k is not none) and (t is not none) and (k < 1) and (t < 3) }}

      - name: "Kort peak nu"
        unique_id: kort_peak_nu
        state: >
          {# True if current hour is expensive but both previous and next are not => "one-hour spike" #}
          {% set prev_state = this.state %}
          {% set k_now = states('sensor.elpriskoefficient_se3') | float(default=none) %}
          {% set p_prev = states('sensor.nord_pool_se3_foregaende_pris') | float(default=none) %}
          {% set p_next = states('sensor.nord_pool_se3_nasta_pris') | float(default=none) %}
          {% set p_now  = states('sensor.nord_pool_se3_aktuellt_pris') | float(default=none) %}

          {% if k_now is none or p_prev is none or p_next is none or p_now is none %}
            {{ prev_state }}
          {% else %}
            {# Tune thresholds #}
            {% set now_expensive = (k_now >= 1.0) %}

            {# spike if current is expensive and both neighbors are lower than now #}
            {{ now_expensive and (p_prev < p_now) and (p_next < p_now) }}
          {% endif %}
