###############################################################################
## SVOTC - Nordpool Price Sensors (2026-02-15)
## Made By Johan Ä
##
## INNEHÅLL:
##   1. Elprisberäkning med alla avgifter (SVOTC-kompatibel)
##   2. Elpriskoefficient (dynamisk prisnivå 0-∞)
##   3. Price band (very_cheap → very_expensive med hysteresis)
##   4. Hjälpsensorer (elpris OK, kort peak)
##
## INSTALLATION:
##   1. Konfigurera input_number-värden med dina avtal
##   2. Uppdatera config_entry ID i nordpool.get_prices_for_date
##   3. Ange din elområde (SE1-SE4) om inte SE3
##   4. För SVOTC: Sätt input_text.svotc_entity_price till 
##      sensor.elpris_total_inkl_avgifter_moms
##
## TIPS:
##   - Elpriskoefficient: <1.0 = billigt, >1.0 = dyrt (relativt dagsspann)
##   - Price band: Använd för automationer med 5 priszoner
##   - Spot exkl moms: För jämförelser/grafer
##   - Total inkl avgifter: För verklig kostnad och SVOTC-styrning
##
###############################################################################

###############################################################################
## 1. KONFIGURATION - Ange dina avtalsvillkor
###############################################################################

input_number:
  #--- Elhandel (SEK/kWh) ---
  elhandel_rorlig_kvart_paslag:
    name: "Elhandel påslag (SEK/kWh)"
    min: 0
    max: 1
    step: 0.001
    unit_of_measurement: "SEK/kWh"
    mode: box
    icon: mdi:plus-circle

  elhandel_rorlig_kvart_elcertifikat:
    name: "Elhandel elcertifikat (SEK/kWh)"
    min: 0
    max: 1
    step: 0.001
    unit_of_measurement: "SEK/kWh"
    mode: box
    icon: mdi:certificate

  elhandel_rorlig_kvart_moms:
    name: "Elhandel moms (%)"
    min: 0
    max: 30
    step: 0.1
    unit_of_measurement: "%"
    mode: box
    icon: mdi:percent

  elhandel_manadsavgift:
    name: "Elhandel månadsavgift (SEK/månad)"
    min: 0
    max: 500
    step: 1
    unit_of_measurement: "SEK/månad"
    mode: box
    icon: mdi:calendar-month

  #--- Nät (SEK/kWh) ---
  nat_eloverforing:
    name: "Nät elöverföring (SEK/kWh)"
    min: 0
    max: 3
    step: 0.001
    unit_of_measurement: "SEK/kWh"
    mode: box
    icon: mdi:transmission-tower

  nat_energiskatt:
    name: "Nät energiskatt (SEK/kWh)"
    min: 0
    max: 3
    step: 0.001
    unit_of_measurement: "SEK/kWh"
    mode: box
    icon: mdi:cash

  nat_moms:
    name: "Nät moms (%)"
    min: 0
    max: 30
    step: 0.1
    unit_of_measurement: "%"
    mode: box
    icon: mdi:percent

###############################################################################
## 2. PRISSENSORER - Hämtar och beräknar elpriser
###############################################################################

template:
  - trigger:
      - platform: time_pattern
        minutes: "/10"
      - platform: homeassistant
        event: start
      - platform: state
        entity_id:
          - input_number.elhandel_rorlig_kvart_paslag
          - input_number.elhandel_rorlig_kvart_elcertifikat
          - input_number.elhandel_rorlig_kvart_moms
          - input_number.nat_eloverforing
          - input_number.nat_energiskatt
          - input_number.nat_moms

    action:
      # VIKTIGT: Uppdatera config_entry till din Nordpool-integration
      - action: nordpool.get_prices_for_date
        data:
          config_entry: 01KGFMFDG6SDFKHQFKK5QKCJ5T  # <-- ÄNDRA DETTA
          date: "{{ now().date() }}"
          areas: SE3  # <-- ÄNDRA TILL DITT OMRÅDE (SE1-SE4)
          currency: SEK
        response_variable: today_price

      - action: nordpool.get_prices_for_date
        data:
          config_entry: 01KGFMFDG6SDFKHQFKK5QKCJ5T  # <-- ÄNDRA DETTA
          date: "{{ (now() + timedelta(days=1)).date() }}"
          areas: SE3  # <-- ÄNDRA TILL DITT OMRÅDE (SE1-SE4)
          currency: SEK
        response_variable: tomorrow_price

    sensor:
      ###########################################################################
      # Spotpris (rent börspris utan tillägg)
      ###########################################################################
      - name: "Elpris spot exkl moms"
        unique_id: elpris_spot_exkl_moms
        device_class: monetary
        unit_of_measurement: "SEK/kWh"
        state_class: measurement
        icon: mdi:flash
        availability: >
          {% set entries = (today_price.get('SE3') or []) %}
          {{ entries | length > 0 }}
        state: >
          {% set entries = (today_price.get('SE3') or []) %}
          {% set now_ts = now().timestamp() %}
          {% set ns = namespace(v=None) %}
          {% for s in entries %}
            {% set st = as_timestamp(s.start) %}
            {% set en = as_timestamp(s.end) %}
            {% if st is not none and en is not none and st <= now_ts < en %}
              {% set ns.v = ((s.price | float(0)) / 1000) | round(3) %}
              {% break %}
            {% endif %}
          {% endfor %}
          {{ ns.v if ns.v is not none else 'unavailable' }}

      ###########################################################################
      # Totalpris (spot + elhandel + nät + moms)
      # SVOTC-KOMPATIBEL: Innehåller raw_today/raw_tomorrow attribut
      ###########################################################################
      - name: "Elpris total (inkl avgifter & moms)"
        unique_id: elpris_total_inkl_avgifter_moms
        device_class: monetary
        unit_of_measurement: "SEK/kWh"
        state_class: measurement
        icon: mdi:cash-multiple
        
        availability: >
          {% set entries = (today_price.get('SE3') or []) %}
          {{ entries | length > 0 }}
        
        state: >
          {% set el_paslag = states('input_number.elhandel_rorlig_kvart_paslag') | float(0) %}
          {% set el_cert = states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) %}
          {% set el_moms = 1 + (states('input_number.elhandel_rorlig_kvart_moms') | float(0) / 100) %}
          {% set nat_overf = states('input_number.nat_eloverforing') | float(0) %}
          {% set nat_skatt = states('input_number.nat_energiskatt') | float(0) %}
          {% set nat_moms = 1 + (states('input_number.nat_moms') | float(0) / 100) %}
          {% set entries = (today_price.get('SE3') or []) %}
          {% set now_ts = now().timestamp() %}
          {% set ns = namespace(v=None) %}
          
          {% for s in entries %}
            {% set st = as_timestamp(s.start) %}
            {% set en = as_timestamp(s.end) %}
            {% if st is not none and en is not none and st <= now_ts < en %}
              {% set spot = (s.price | float(0)) / 1000 %}
              {% set elhandel = (spot + el_paslag + el_cert) * el_moms %}
              {% set nat = (nat_overf + nat_skatt) * nat_moms %}
              {% set ns.v = elhandel + nat %}
              {% break %}
            {% endif %}
          {% endfor %}
          {{ ns.v | round(3) if ns.v is not none else 'unavailable' }}

        attributes:
          unit: kWh
          currency: SEK
          country: Sweden
          region: SE3
          
          # Avtalsvillkor (synligt i attributes)
          elhandel_paslag: "{{ states('input_number.elhandel_rorlig_kvart_paslag') | float(0) }}"
          elhandel_cert: "{{ states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) }}"
          elhandel_moms: "{{ states('input_number.elhandel_rorlig_kvart_moms') | float(0) }}"
          nat_overforing: "{{ states('input_number.nat_eloverforing') | float(0) }}"
          nat_skatt: "{{ states('input_number.nat_energiskatt') | float(0) }}"
          nat_moms: "{{ states('input_number.nat_moms') | float(0) }}"

          # SVOTC-REQUIRED: Current price attribut
          current_price: >
            {% set el_paslag = states('input_number.elhandel_rorlig_kvart_paslag') | float(0) %}
            {% set el_cert = states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) %}
            {% set el_moms = 1 + (states('input_number.elhandel_rorlig_kvart_moms') | float(0) / 100) %}
            {% set nat_overf = states('input_number.nat_eloverforing') | float(0) %}
            {% set nat_skatt = states('input_number.nat_energiskatt') | float(0) %}
            {% set nat_moms = 1 + (states('input_number.nat_moms') | float(0) / 100) %}
            {% set now_ts = now().timestamp() %}
            {% set entries = (today_price.get('SE3') or []) + (tomorrow_price.get('SE3') or []) %}
            {% set ns = namespace(p=None) %}
            
            {% for s in entries %}
              {% set st = as_timestamp(s.start) %}
              {% set en = as_timestamp(s.end) %}
              {% if st is not none and en is not none and st <= now_ts < en %}
                {% set spot = (s.price | float(0)) / 1000 %}
                {% set elhandel = (spot + el_paslag + el_cert) * el_moms %}
                {% set nat = (nat_overf + nat_skatt) * nat_moms %}
                {% set ns.p = (elhandel + nat) | round(3) %}
              {% endif %}
            {% endfor %}
            {{ ns.p if ns.p is not none else 'unavailable' }}

          # Min/max för dagens priser
          min: >
            {% set el_paslag = states('input_number.elhandel_rorlig_kvart_paslag') | float(0) %}
            {% set el_cert = states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) %}
            {% set el_moms = 1 + (states('input_number.elhandel_rorlig_kvart_moms') | float(0) / 100) %}
            {% set nat_overf = states('input_number.nat_eloverforing') | float(0) %}
            {% set nat_skatt = states('input_number.nat_energiskatt') | float(0) %}
            {% set nat_moms = 1 + (states('input_number.nat_moms') | float(0) / 100) %}
            {% set entries = (today_price.get('SE3') or []) %}
            {% if entries %}
              {% set spot_min = (entries | map(attribute='price') | map('float') | list | min) / 1000 %}
              {% set elhandel = (spot_min + el_paslag + el_cert) * el_moms %}
              {% set nat = (nat_overf + nat_skatt) * nat_moms %}
              {{ (elhandel + nat) | round(3) }}
            {% else %}
              unavailable
            {% endif %}

          max: >
            {% set el_paslag = states('input_number.elhandel_rorlig_kvart_paslag') | float(0) %}
            {% set el_cert = states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) %}
            {% set el_moms = 1 + (states('input_number.elhandel_rorlig_kvart_moms') | float(0) / 100) %}
            {% set nat_overf = states('input_number.nat_eloverforing') | float(0) %}
            {% set nat_skatt = states('input_number.nat_energiskatt') | float(0) %}
            {% set nat_moms = 1 + (states('input_number.nat_moms') | float(0) / 100) %}
            {% set entries = (today_price.get('SE3') or []) %}
            {% if entries %}
              {% set spot_max = (entries | map(attribute='price') | map('float') | list | max) / 1000 %}
              {% set elhandel = (spot_max + el_paslag + el_cert) * el_moms %}
              {% set nat = (nat_overf + nat_skatt) * nat_moms %}
              {{ (elhandel + nat) | round(3) }}
            {% else %}
              unavailable
            {% endif %}

          # SVOTC-REQUIRED: raw_today och raw_tomorrow med start/end/value
          raw_today: >
            {% set el_paslag = states('input_number.elhandel_rorlig_kvart_paslag') | float(0) %}
            {% set el_cert = states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) %}
            {% set el_moms = 1 + (states('input_number.elhandel_rorlig_kvart_moms') | float(0) / 100) %}
            {% set nat_overf = states('input_number.nat_eloverforing') | float(0) %}
            {% set nat_skatt = states('input_number.nat_energiskatt') | float(0) %}
            {% set nat_moms = 1 + (states('input_number.nat_moms') | float(0) / 100) %}
            {% set entries = (today_price.get('SE3') or []) %}
            {% set ns = namespace(r=[]) %}
            
            {% for s in entries %}
              {% set spot = (s.price | float(0)) / 1000 %}
              {% set elhandel = (spot + el_paslag + el_cert) * el_moms %}
              {% set nat = (nat_overf + nat_skatt) * nat_moms %}
              {% set val = (elhandel + nat) %}
              {% set ns.r = ns.r + [{
                'start': (s.start | as_datetime | as_local).isoformat(),
                'end': (s.end | as_datetime | as_local).isoformat(),
                'value': (val | round(3))
              }] %}
            {% endfor %}
            {{ ns.r }}

          raw_tomorrow: >
            {% set entries = (tomorrow_price.get('SE3') or []) %}
            {% if not entries %}
              []
            {% else %}
              {% set el_paslag = states('input_number.elhandel_rorlig_kvart_paslag') | float(0) %}
              {% set el_cert = states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) %}
              {% set el_moms = 1 + (states('input_number.elhandel_rorlig_kvart_moms') | float(0) / 100) %}
              {% set nat_overf = states('input_number.nat_eloverforing') | float(0) %}
              {% set nat_skatt = states('input_number.nat_energiskatt') | float(0) %}
              {% set nat_moms = 1 + (states('input_number.nat_moms') | float(0) / 100) %}
              {% set ns = namespace(r=[]) %}
              
              {% for s in entries %}
                {% set spot = (s.price | float(0)) / 1000 %}
                {% set elhandel = (spot + el_paslag + el_cert) * el_moms %}
                {% set nat = (nat_overf + nat_skatt) * nat_moms %}
                {% set val = (elhandel + nat) %}
                {% set ns.r = ns.r + [{
                  'start': (s.start | as_datetime | as_local).isoformat(),
                  'end': (s.end | as_datetime | as_local).isoformat(),
                  'value': (val | round(3))
                }] %}
              {% endfor %}
              {{ ns.r }}
            {% endif %}

###############################################################################
## 3. ANALYSSENSORER - Priskoefficient & priszoner
###############################################################################

  - sensor:
      ###########################################################################
      # Elpriskoefficient: Dynamisk prisnivå relativt dagsspann
      # <1.0 = billigt, >1.0 = dyrt
      # Formel anpassar sig efter både min/max-nivåer
      ###########################################################################
      - name: "Elpriskoefficient"
        unique_id: elpriskoefficient
        unit_of_measurement: ""
        state: >
          {% set price = states('sensor.elpris_total_inkl_avgifter_moms') | float(none) %}
          {% set pmax = state_attr('sensor.elpris_total_inkl_avgifter_moms', 'max') | float(none) %}
          {% set pmin = state_attr('sensor.elpris_total_inkl_avgifter_moms', 'min') | float(none) %}
          
          {% if price is none or pmax is none or pmin is none or pmax <= 0 %}
            {{ this.state | default(0) }}
          {% else %}
            {% set threshold = (pmax - pmin) * (1.3 * (pmax ** -0.7)) * (1 / (1 + pmin * 0.25)) + pmin %}
            {{ (price / threshold) | round(2) }}
          {% endif %}

      ###########################################################################
      # Price band: 5 zoner med hysteresis för stabila övergångar
      # very_cheap → cheap → normal → expensive → very_expensive
      ###########################################################################
      - name: "Nordpool price band"
        unique_id: nordpool_price_band_dynamic_minmax
        state: >
          {% set price = states('sensor.elpris_total_inkl_avgifter_moms') | float(0) %}
          {% set pmin = state_attr('sensor.elpris_total_inkl_avgifter_moms', 'min') | float(price) %}
          {% set pmax = state_attr('sensor.elpris_total_inkl_avgifter_moms', 'max') | float(price) %}
          {% set span = pmax - pmin %}
          
          {% if span <= 0 %}
            normal
          {% else %}
            {% set x = (price - pmin) / span %}
            {% set prev = this.state | default('normal') %}
            {% set h = 0.02 %}
            
            {# Bas-trösklar #}
            {% set t_vc = 0.15 %}
            {% set t_c = 0.35 %}
            {% set t_e = 0.65 %}
            {% set t_ve = 0.85 %}
            
            {# Hysteresis baserat på föregående state #}
            {% if prev == 'very_cheap' %}
              {% set t_vc = t_vc + h %}
            {% elif prev == 'cheap' %}
              {% set t_vc = t_vc - h %}
              {% set t_c = t_c + h %}
            {% elif prev == 'normal' %}
              {% set t_c = t_c - h %}
              {% set t_e = t_e + h %}
            {% elif prev == 'expensive' %}
              {% set t_e = t_e - h %}
              {% set t_ve = t_ve + h %}
            {% elif prev == 'very_expensive' %}
              {% set t_ve = t_ve - h %}
            {% endif %}
            
            {% if x <= t_vc %}very_cheap
            {% elif x <= t_c %}cheap
            {% elif x < t_e %}normal
            {% elif x <= t_ve %}expensive
            {% else %}very_expensive
            {% endif %}
          {% endif %}
        
        attributes:
          current_price: "{{ states('sensor.elpris_total_inkl_avgifter_moms') | float(0) }}"
          today_min: "{{ state_attr('sensor.elpris_total_inkl_avgifter_moms', 'min') | float(0) }}"
          today_max: "{{ state_attr('sensor.elpris_total_inkl_avgifter_moms', 'max') | float(0) }}"
          normalized_0_1: >
            {% set price = states('sensor.elpris_total_inkl_avgifter_moms') | float(0) %}
            {% set pmin = state_attr('sensor.elpris_total_inkl_avgifter_moms', 'min') | float(price) %}
            {% set pmax = state_attr('sensor.elpris_total_inkl_avgifter_moms', 'max') | float(price) %}
            {% set span = pmax - pmin %}
            {{ ((price - pmin) / span) | round(3) if span > 0 else 0.5 }}
          thresholds: "vc:0.15, c:0.35, e:0.65, ve:0.85"
          hysteresis: "±0.02"

###############################################################################
## 4. HJÄLPSENSORER - Binära statusar
###############################################################################

  - binary_sensor:
      ###########################################################################
      # Elpris OK: True när priset är lågt OCH temperaturen är mild
      # Användbart för automationer som vill dra nytta av billig el
      ###########################################################################
      - name: "Elpris OK"
        unique_id: elpris_ok
        state: >
          {% set k = states('sensor.elpriskoefficient') | float(none) %}
          {{ (k is not none) and (k < 1.0) }}
      ###########################################################################
      # Kort peak nu: True under korta pristoppar (koefficient >= 1.0)
      # Användbart för att pausa icke-kritisk förbrukning
      ###########################################################################
      - name: "Kort peak nu"
        unique_id: kort_peak_nu
        state: >
          {% set k = states('sensor.elpriskoefficient') | float(none) %}
          {% set entries = state_attr('sensor.elpris_total_inkl_avgifter_moms', 'raw_today') or [] %}
          {{ (k is not none) and (entries | length > 2) and (k >= 1.0) }}

###############################################################################
## ANVÄNDNINGSEXEMPEL
##
## 1. SVOTC Integration:
##    input_text.svotc_entity_price: sensor.elpris_total_inkl_avgifter_moms
##
## 2. Automation med price band:
##    trigger:
##      - platform: state
##        entity_id: sensor.nordpool_price_band
##        to: 'very_cheap'
##    action:
##      - service: switch.turn_on
##        target:
##          entity_id: switch.varmvattenberedare
##
## 3. Automation med koefficient:
##    condition:
##      - condition: numeric_state
##        entity_id: sensor.elpriskoefficient
##        below: 0.8
##    action:
##      - service: climate.set_temperature
##        target:
##          entity_id: climate.vardagsrum
##        data:
##          temperature: 22
##
###############################################################################
