input_number:
  # --- Elhandel (SEK/kWh) ---
  elhandel_rorlig_kvart_paslag:
    name: "Elhandel påslag (SEK/kWh)"
    min: 0
    max: 1
    step: 0.001
    unit_of_measurement: "SEK/kWh"
    mode: box
    icon: mdi:plus-circle

  elhandel_rorlig_kvart_elcertifikat:
    name: "Elhandel elcertifikat (SEK/kWh)"
    min: 0
    max: 1
    step: 0.001
    unit_of_measurement: "SEK/kWh"
    mode: box
    icon: mdi:certificate

  elhandel_rorlig_kvart_moms:
    name: "Elhandel moms (%)"
    min: 0
    max: 30
    step: 0.1
    unit_of_measurement: "%"
    mode: box
    icon: mdi:percent

  elhandel_manadsavgift:
    name: "Elhandel månadsavgift (SEK/månad)"
    min: 0
    max: 500
    step: 1
    unit_of_measurement: "SEK/månad"
    mode: box
    icon: mdi:calendar-month

  # --- Nät (SEK/kWh) ---
  nat_eloverforing:
    name: "Nät elöverföring (SEK/kWh)"
    min: 0
    max: 3
    step: 0.001
    unit_of_measurement: "SEK/kWh"
    mode: box
    icon: mdi:transmission-tower

  nat_energiskatt:
    name: "Nät energiskatt (SEK/kWh)"
    min: 0
    max: 3
    step: 0.001
    unit_of_measurement: "SEK/kWh"
    mode: box
    icon: mdi:cash

  nat_moms:
    name: "Nät moms (%)"
    min: 0
    max: 30
    step: 0.1
    unit_of_measurement: "%"
    mode: box
    icon: mdi:percent


template:
  - trigger:
      - platform: time_pattern
        minutes: "/10"
      - platform: homeassistant
        event: start
      - platform: state
        entity_id:
          - input_number.elhandel_rorlig_kvart_paslag
          - input_number.elhandel_rorlig_kvart_elcertifikat
          - input_number.elhandel_rorlig_kvart_moms
          - input_number.elhandel_manadsavgift
          - input_number.nat_eloverforing
          - input_number.nat_energiskatt
          - input_number.nat_moms

    action:
      - action: nordpool.get_prices_for_date
        data:
          config_entry: 01KGFMFDG6SDFKHQFKK5QKCJ5T
          date: "{{ now().date() }}"
          areas: SE3
          currency: SEK
        response_variable: today_price

      - action: nordpool.get_prices_for_date
        data:
          config_entry: 01KGFMFDG6SDFKHQFKK5QKCJ5T
          date: "{{ (now() + timedelta(days=1)).date() }}"
          areas: SE3
          currency: SEK
        response_variable: tomorrow_price

    sensor:
      ##########################################################################
      # 1) Ren spot (exkl moms & exkl allt)  --> sensor.elpris_spot_exkl_moms
      ##########################################################################
      - name: "Elpris spot exkl moms"
        unique_id: elpris_spot_exkl_moms
        device_class: monetary
        unit_of_measurement: "SEK/kWh"
        state_class: measurement
        icon: mdi:flash

        availability: >
          {% set entries = (today_price.get('SE3') or []) %}
          {{ entries | length > 0 }}

        state: >
          {% set entries = (today_price.get('SE3') or []) %}
          {% set now_ts = now().timestamp() %}
          {% set ns = namespace(v=None) %}
          {% for s in entries %}
            {% set st = as_timestamp(s.start) %}
            {% set en = as_timestamp(s.end) %}
            {% if st is not none and en is not none and st <= now_ts < en %}
              {% set ns.v = (s.price | float(0)) / 1000 %}
              {% break %}
            {% endif %}
          {% endfor %}
          {{ ns.v | round(3) if ns.v is not none else 'unavailable' }}


      ##########################################################################
      # 2) Totalpris (spot + elhandel + nät + respektive moms)
      ##########################################################################
      - name: "Elpris total (inkl avgifter & moms)"
        unique_id: elpris_total_inkl_avgifter_moms
        device_class: monetary
        unit_of_measurement: "SEK/kWh"
        state_class: measurement
        icon: mdi:cash-multiple

        availability: >
          {% set entries = (today_price.get('SE3') or []) %}
          {{ entries | length > 0 }}

        state: >
          {% set el_paslag_sek = states('input_number.elhandel_rorlig_kvart_paslag') | float(0) %}
          {% set el_elcert_sek = states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) %}
          {% set el_moms = 1 + (states('input_number.elhandel_rorlig_kvart_moms') | float(0) / 100) %}

          {% set nat_eloverf_sek = states('input_number.nat_eloverforing') | float(0) %}
          {% set nat_skatt_sek   = states('input_number.nat_energiskatt') | float(0) %}
          {% set nat_moms = 1 + (states('input_number.nat_moms') | float(0) / 100) %}

          {% set entries = (today_price.get('SE3') or []) %}
          {% set now_ts = now().timestamp() %}
          {% set ns = namespace(v=None) %}

          {% for s in entries %}
            {% set st = as_timestamp(s.start) %}
            {% set en = as_timestamp(s.end) %}
            {% if st is not none and en is not none and st <= now_ts < en %}
              {% set spot = (s.price | float(0)) / 1000 %}
              {% set elhandel = (spot + el_paslag_sek + el_elcert_sek) * el_moms %}
              {% set nat = (nat_eloverf_sek + nat_skatt_sek) * nat_moms %}
              {% set ns.v = elhandel + nat %}
              {% break %}
            {% endif %}
          {% endfor %}

          {{ ns.v | round(3) if ns.v is not none else 'unavailable' }}

        attributes:
          unit: kWh
          currency: SEK
          country: Sweden
          region: SE3

          # --- Elhandel ---
          elhandel_rorlig_kvart_paslag: "{{ states('input_number.elhandel_rorlig_kvart_paslag') | float(0) }}"
          elhandel_rorlig_kvart_elcertifikat: "{{ states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) }}"
          elhandel_rorlig_kvart_moms: "{{ states('input_number.elhandel_rorlig_kvart_moms') | float(0) }}"
          elhandel_manadsavgift: "{{ states('input_number.elhandel_manadsavgift') | float(0) }}"

          # --- Nät ---
          nat_eloverforing: "{{ states('input_number.nat_eloverforing') | float(0) }}"
          nat_energiskatt: "{{ states('input_number.nat_energiskatt') | float(0) }}"
          nat_moms: "{{ states('input_number.nat_moms') | float(0) }}"

          # --- SVOTC-kompatibelt ---
          current_price: >
            {% set el_paslag_sek = states('input_number.elhandel_rorlig_kvart_paslag') | float(0) %}
            {% set el_elcert_sek = states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) %}
            {% set el_moms = 1 + (states('input_number.elhandel_rorlig_kvart_moms') | float(0) / 100) %}

            {% set nat_eloverf_sek = states('input_number.nat_eloverforing') | float(0) %}
            {% set nat_skatt_sek   = states('input_number.nat_energiskatt') | float(0) %}
            {% set nat_moms = 1 + (states('input_number.nat_moms') | float(0) / 100) %}

            {% set now_ts = now().timestamp() %}
            {% set entries = (today_price.get('SE3') or []) + (tomorrow_price.get('SE3') or []) %}
            {% set ns = namespace(p=None) %}

            {% for s in entries %}
              {% set st = as_timestamp(s.start) %}
              {% set en = as_timestamp(s.end) %}
              {% if st is not none and en is not none and st <= now_ts < en %}
                {% set spot = (s.price | float(0)) / 1000 %}
                {% set elhandel = (spot + el_paslag_sek + el_elcert_sek) * el_moms %}
                {% set nat = (nat_eloverf_sek + nat_skatt_sek) * nat_moms %}
                {% set ns.p = (elhandel + nat) | round(3) %}
              {% endif %}
            {% endfor %}
            {{ ns.p if ns.p is not none else 'unavailable' }}

          tomorrow_valid: >
            {{ (tomorrow_price.get('SE3') or []) | length > 0 }}

          min: >
            {% set el_paslag_sek = states('input_number.elhandel_rorlig_kvart_paslag') | float(0) %}
            {% set el_elcert_sek = states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) %}
            {% set el_moms = 1 + (states('input_number.elhandel_rorlig_kvart_moms') | float(0) / 100) %}

            {% set nat_eloverf_sek = states('input_number.nat_eloverforing') | float(0) %}
            {% set nat_skatt_sek   = states('input_number.nat_energiskatt') | float(0) %}
            {% set nat_moms = 1 + (states('input_number.nat_moms') | float(0) / 100) %}

            {% set entries = (today_price.get('SE3') or []) %}
            {% if entries %}
              {% set spot_min = (entries | map(attribute='price') | map('float') | list | min) / 1000 %}
              {% set elhandel = (spot_min + el_paslag_sek + el_elcert_sek) * el_moms %}
              {% set nat = (nat_eloverf_sek + nat_skatt_sek) * nat_moms %}
              {{ (elhandel + nat) | round(3) }}
            {% else %}unavailable{% endif %}

          max: >
            {% set el_paslag_sek = states('input_number.elhandel_rorlig_kvart_paslag') | float(0) %}
            {% set el_elcert_sek = states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) %}
            {% set el_moms = 1 + (states('input_number.elhandel_rorlig_kvart_moms') | float(0) / 100) %}

            {% set nat_eloverf_sek = states('input_number.nat_eloverforing') | float(0) %}
            {% set nat_skatt_sek   = states('input_number.nat_energiskatt') | float(0) %}
            {% set nat_moms = 1 + (states('input_number.nat_moms') | float(0) / 100) %}

            {% set entries = (today_price.get('SE3') or []) %}
            {% if entries %}
              {% set spot_max = (entries | map(attribute='price') | map('float') | list | max) / 1000 %}
              {% set elhandel = (spot_max + el_paslag_sek + el_elcert_sek) * el_moms %}
              {% set nat = (nat_eloverf_sek + nat_skatt_sek) * nat_moms %}
              {{ (elhandel + nat) | round(3) }}
            {% else %}unavailable{% endif %}

          today: >
            {% set el_paslag_sek = states('input_number.elhandel_rorlig_kvart_paslag') | float(0) %}
            {% set el_elcert_sek = states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) %}
            {% set el_moms = 1 + (states('input_number.elhandel_rorlig_kvart_moms') | float(0) / 100) %}

            {% set nat_eloverf_sek = states('input_number.nat_eloverforing') | float(0) %}
            {% set nat_skatt_sek   = states('input_number.nat_energiskatt') | float(0) %}
            {% set nat_moms = 1 + (states('input_number.nat_moms') | float(0) / 100) %}

            {% set e = (today_price.get('SE3') or []) %}
            {% set ns = namespace(vals=[]) %}

            {% for s in e %}
              {% set spot = (s.price | float(0)) / 1000 %}
              {% set elhandel = (spot + el_paslag_sek + el_elcert_sek) * el_moms %}
              {% set nat = (nat_eloverf_sek + nat_skatt_sek) * nat_moms %}
              {% set ns.vals = ns.vals + [ (elhandel + nat) | round(3) ] %}
            {% endfor %}
            {{ ns.vals }}

          tomorrow: >
            {% set e = (tomorrow_price.get('SE3') or []) %}
            {% if not e %}
              []
            {% else %}
              {% set el_paslag_sek = states('input_number.elhandel_rorlig_kvart_paslag') | float(0) %}
              {% set el_elcert_sek = states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) %}
              {% set el_moms = 1 + (states('input_number.elhandel_rorlig_kvart_moms') | float(0) / 100) %}

              {% set nat_eloverf_sek = states('input_number.nat_eloverforing') | float(0) %}
              {% set nat_skatt_sek   = states('input_number.nat_energiskatt') | float(0) %}
              {% set nat_moms = 1 + (states('input_number.nat_moms') | float(0) / 100) %}

              {% set ns = namespace(vals=[]) %}

              {% for s in e %}
                {% set spot = (s.price | float(0)) / 1000 %}
                {% set elhandel = (spot + el_paslag_sek + el_elcert_sek) * el_moms %}
                {% set nat = (nat_eloverf_sek + nat_skatt_sek) * nat_moms %}
                {% set ns.vals = ns.vals + [ (elhandel + nat) | round(3) ] %}
              {% endfor %}
              {{ ns.vals }}
            {% endif %}

          raw_today: >
            {% set el_paslag_sek = states('input_number.elhandel_rorlig_kvart_paslag') | float(0) %}
            {% set el_elcert_sek = states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) %}
            {% set el_moms = 1 + (states('input_number.elhandel_rorlig_kvart_moms') | float(0) / 100) %}

            {% set nat_eloverf_sek = states('input_number.nat_eloverforing') | float(0) %}
            {% set nat_skatt_sek   = states('input_number.nat_energiskatt') | float(0) %}
            {% set nat_moms = 1 + (states('input_number.nat_moms') | float(0) / 100) %}

            {% set e = (today_price.get('SE3') or []) %}
            {% set ns = namespace(r=[]) %}

            {% for s in e %}
              {% set spot = (s.price | float(0)) / 1000 %}
              {% set elhandel = (spot + el_paslag_sek + el_elcert_sek) * el_moms %}
              {% set nat = (nat_eloverf_sek + nat_skatt_sek) * nat_moms %}
              {% set val = (elhandel + nat) %}
              {% set ns.r = ns.r + [{
                'start': (s.start | as_datetime | as_local).isoformat(),
                'end':   (s.end   | as_datetime | as_local).isoformat(),
                'value': (val | round(3))
              }] %}
            {% endfor %}
            {{ ns.r }}

          raw_tomorrow: >
            {% set e = (tomorrow_price.get('SE3') or []) %}
            {% if not e %}
              []
            {% else %}
              {% set el_paslag_sek = states('input_number.elhandel_rorlig_kvart_paslag') | float(0) %}
              {% set el_elcert_sek = states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) %}
              {% set el_moms = 1 + (states('input_number.elhandel_rorlig_kvart_moms') | float(0) / 100) %}

              {% set nat_eloverf_sek = states('input_number.nat_eloverforing') | float(0) %}
              {% set nat_skatt_sek   = states('input_number.nat_energiskatt') | float(0) %}
              {% set nat_moms = 1 + (states('input_number.nat_moms') | float(0) / 100) %}

              {% set ns = namespace(r=[]) %}

              {% for s in e %}
                {% set spot = (s.price | float(0)) / 1000 %}
                {% set elhandel = (spot + el_paslag_sek + el_elcert_sek) * el_moms %}
                {% set nat = (nat_eloverf_sek + nat_skatt_sek) * nat_moms %}
                {% set val = (elhandel + nat) %}
                {% set ns.r = ns.r + [{
                  'start': (s.start | as_datetime | as_local).isoformat(),
                  'end':   (s.end   | as_datetime | as_local).isoformat(),
                  'value': (val | round(3))
                }] %}
              {% endfor %}
              {{ ns.r }}
            {% endif %}
