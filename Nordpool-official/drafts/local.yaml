###############################################################################
# SVOTC - Nordpool Prissensorer (2026-02-15)
# Made By Johan Ä & Gemini & Claude
#
# ÄNDRA DESSA VÄRDEN:
# - config_entry: "01KGFMFDG6SDFKHQFKK5QKCJ5T"  → din Nordpool integration-ID
# - areas: SE3                                   → ditt prisområde (SE1/SE2/SE3/SE4)
###############################################################################

###############################################################################
# 1. KONFIGURATION - Ange dina avtalsvillkor
###############################################################################
input_number:

  # — Elhandel —
  elhandel_rorlig_kvart_paslag:
    name: "Elhandel påslag (SEK/kWh)"
    min: 0
    max: 1
    step: 0.001
    unit_of_measurement: "SEK/kWh"
    mode: box
    icon: mdi:plus-circle

  elhandel_rorlig_kvart_elcertifikat:
    name: "Elhandel elcertifikat (SEK/kWh)"
    min: 0
    max: 1
    step: 0.001
    unit_of_measurement: "SEK/kWh"
    mode: box
    icon: mdi:certificate

  elhandel_rorlig_kvart_moms:
    name: "Elhandel moms (%)"
    min: 0
    max: 30
    step: 0.1
    unit_of_measurement: "%"
    mode: box
    icon: mdi:percent

  # — Nät —
  nat_eloverforing:
    name: "Nät elöverföring (SEK/kWh)"
    min: 0
    max: 3
    step: 0.001
    unit_of_measurement: "SEK/kWh"
    mode: box
    icon: mdi:transmission-tower

  nat_energiskatt:
    name: "Nät energiskatt (SEK/kWh)"
    min: 0
    max: 3
    step: 0.001
    unit_of_measurement: "SEK/kWh"
    mode: box
    icon: mdi:cash

  nat_moms:
    name: "Nät moms (%)"
    min: 0
    max: 30
    step: 0.1
    unit_of_measurement: "%"
    mode: box
    icon: mdi:percent

  # — Solceller: försäljning —
  sol_skattereduktion:
    name: "Solceller skattereduktion (SEK/kWh)"
    min: 0
    max: 1
    step: 0.001
    unit_of_measurement: "SEK/kWh"
    mode: box
    icon: mdi:solar-power

  sol_inmatningsersattning:
    name: "Solceller inmatningsersättning (SEK/kWh)"
    min: 0
    max: 0.5
    step: 0.001
    unit_of_measurement: "SEK/kWh"
    mode: box
    icon: mdi:transmission-tower-export

###############################################################################
# 2. PRISSENSORER - Hämtar rådata från Nordpool
# Triggas var 10:e minut + vid start + vid inmatningsändring
###############################################################################
template:
  - trigger:
      - platform: time_pattern
        minutes: "/10"
      - platform: homeassistant
        event: start
      - platform: state
        entity_id:
          - input_number.elhandel_rorlig_kvart_paslag
          - input_number.elhandel_rorlig_kvart_elcertifikat
          - input_number.elhandel_rorlig_kvart_moms
          - input_number.nat_eloverforing
          - input_number.nat_energiskatt
          - input_number.nat_moms
          - input_number.sol_skattereduktion
          - input_number.sol_inmatningsersattning

    action:
      # Hämta dagens priser
      - action: nordpool.get_prices_for_date
        data:
          config_entry: 01KGFMFDG6SDFKHQFKK5QKCJ5T   # <– DIN INTEGRATION ID
          date: "{{ now().date() }}"
          areas: SE3                                 # <– DITT OMRÅDE
          currency: SEK
        response_variable: today_price

      # Hämta morgondagens priser (tillgängliga ca 13:00 CET)
      - action: nordpool.get_prices_for_date
        data:
          config_entry: 01KGFMFDG6SDFKHQFKK5QKCJ5T   # <– DIN INTEGRATION ID
          date: "{{ (now() + timedelta(days=1)).date() }}"
          areas: SE3                                 # <– DITT OMRÅDE
          currency: SEK
        response_variable: tomorrow_price

    sensor:

      #########################################################################
      # SENSOR 1: Elpris Elhandel (spot + elhandel, UTAN nät)
      #########################################################################
      - name: "Elpris elhandel"
        unique_id: elpris_elhandel
        device_class: monetary
        unit_of_measurement: "SEK/kWh"
        icon: mdi:lightning-bolt-circle

        availability: >
          {% set area = 'SE3' %}
          {{ (today_price.get(area) or []) | length > 0 }}

        state: >
          {% set area = 'SE3' %}
          {% set el_paslag = states('input_number.elhandel_rorlig_kvart_paslag') | float(0) %}
          {% set el_cert   = states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) %}
          {% set el_moms   = 1 + (states('input_number.elhandel_rorlig_kvart_moms') | float(0) / 100) %}
          {% set entries   = (today_price.get(area) or []) %}
          {% set now_ts    = now().timestamp() %}
          {% set ns = namespace(v=None) %}
          {% for s in entries %}
            {% set st = as_timestamp(s.start) %}
            {% set en = as_timestamp(s.end) %}
            {% if st is not none and en is not none and st <= now_ts < en %}
              {% set spot  = (s.price | float(0)) / 1000 %}
              {% set ns.v  = (spot + el_paslag + el_cert) * el_moms %}
            {% endif %}
          {% endfor %}
          {{ ns.v | round(4) if ns.v is not none else 'unavailable' }}

        attributes:
          min: >
            {% set area = 'SE3' %}
            {% set el_paslag = states('input_number.elhandel_rorlig_kvart_paslag') | float(0) %}
            {% set el_cert   = states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) %}
            {% set el_moms   = 1 + (states('input_number.elhandel_rorlig_kvart_moms') | float(0) / 100) %}
            {% set entries   = (today_price.get(area) or []) %}
            {% if entries %}
              {% set spot_min = (entries | map(attribute='price') | map('float') | list | min) / 1000 %}
              {{ ((spot_min + el_paslag + el_cert) * el_moms) | round(4) }}
            {% else %}unavailable{% endif %}

          max: >
            {% set area = 'SE3' %}
            {% set el_paslag = states('input_number.elhandel_rorlig_kvart_paslag') | float(0) %}
            {% set el_cert   = states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) %}
            {% set el_moms   = 1 + (states('input_number.elhandel_rorlig_kvart_moms') | float(0) / 100) %}
            {% set entries   = (today_price.get(area) or []) %}
            {% if entries %}
              {% set spot_max = (entries | map(attribute='price') | map('float') | list | max) / 1000 %}
              {{ ((spot_max + el_paslag + el_cert) * el_moms) | round(4) }}
            {% else %}unavailable{% endif %}

          raw_today: >
            {% set area = 'SE3' %}
            {% set el_paslag = states('input_number.elhandel_rorlig_kvart_paslag') | float(0) %}
            {% set el_cert   = states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) %}
            {% set el_moms   = 1 + (states('input_number.elhandel_rorlig_kvart_moms') | float(0) / 100) %}
            {% set entries   = (today_price.get(area) or []) %}
            {% set ns = namespace(r=[]) %}
            {% for s in entries %}
              {% set val = ((s.price / 1000) + el_paslag + el_cert) * el_moms %}
              {% set ns.r = ns.r + [{
                'start': (s.start | as_datetime | as_local).isoformat(),
                'end':   (s.end   | as_datetime | as_local).isoformat(),
                'value': (val | round(4))
              }] %}
            {% endfor %}
            {{ ns.r }}

          raw_tomorrow: >
            {% set area = 'SE3' %}
            {% set el_paslag = states('input_number.elhandel_rorlig_kvart_paslag') | float(0) %}
            {% set el_cert   = states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) %}
            {% set el_moms   = 1 + (states('input_number.elhandel_rorlig_kvart_moms') | float(0) / 100) %}
            {% set entries   = (tomorrow_price.get(area) or []) %}
            {% set ns = namespace(r=[]) %}
            {% for s in entries %}
              {% set val = ((s.price / 1000) + el_paslag + el_cert) * el_moms %}
              {% set ns.r = ns.r + [{
                'start': (s.start | as_datetime | as_local).isoformat(),
                'end':   (s.end   | as_datetime | as_local).isoformat(),
                'value': (val | round(4))
              }] %}
            {% endfor %}
            {{ ns.r }}

          hours_today: >
            {{ (today_price.get('SE3') or []) | length }}

          hours_tomorrow: >
            {{ (tomorrow_price.get('SE3') or []) | length }}

      #########################################################################
      # SENSOR 2: Elpris Total inkl nät
      #########################################################################
      - name: "Elpris total inkl nät"
        unique_id: elpris_total_inkl_nat
        device_class: monetary
        unit_of_measurement: "SEK/kWh"
        icon: mdi:cash-multiple

        availability: >
          {% set area = 'SE3' %}
          {{ (today_price.get(area) or []) | length > 0 }}

        state: >
          {% set area      = 'SE3' %}
          {% set el_paslag = states('input_number.elhandel_rorlig_kvart_paslag') | float(0) %}
          {% set el_cert   = states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) %}
          {% set el_moms   = 1 + (states('input_number.elhandel_rorlig_kvart_moms') | float(0) / 100) %}
          {% set nat_overf = states('input_number.nat_eloverforing') | float(0) %}
          {% set nat_skatt = states('input_number.nat_energiskatt') | float(0) %}
          {% set nat_moms  = 1 + (states('input_number.nat_moms') | float(0) / 100) %}
          {% set entries   = (today_price.get(area) or []) %}
          {% set now_ts    = now().timestamp() %}
          {% set ns = namespace(v=None) %}
          {% for s in entries %}
            {% set st = as_timestamp(s.start) %}
            {% set en = as_timestamp(s.end) %}
            {% if st is not none and en is not none and st <= now_ts < en %}
              {% set spot     = (s.price | float(0)) / 1000 %}
              {% set elhandel = (spot + el_paslag + el_cert) * el_moms %}
              {% set nat      = (nat_overf + nat_skatt) * nat_moms %}
              {% set ns.v     = elhandel + nat %}
            {% endif %}
          {% endfor %}
          {{ ns.v | round(4) if ns.v is not none else 'unavailable' }}

        attributes:
          min: >
            {% set area      = 'SE3' %}
            {% set el_paslag = states('input_number.elhandel_rorlig_kvart_paslag') | float(0) %}
            {% set el_cert   = states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) %}
            {% set el_moms   = 1 + (states('input_number.elhandel_rorlig_kvart_moms') | float(0) / 100) %}
            {% set nat_overf = states('input_number.nat_eloverforing') | float(0) %}
            {% set nat_skatt = states('input_number.nat_energiskatt') | float(0) %}
            {% set nat_moms  = 1 + (states('input_number.nat_moms') | float(0) / 100) %}
            {% set entries   = (today_price.get(area) or []) %}
            {% if entries %}
              {% set spot_min = (entries | map(attribute='price') | map('float') | list | min) / 1000 %}
              {{ (((spot_min + el_paslag + el_cert) * el_moms) + ((nat_overf + nat_skatt) * nat_moms)) | round(4) }}
            {% else %}unavailable{% endif %}

          max: >
            {% set area      = 'SE3' %}
            {% set el_paslag = states('input_number.elhandel_rorlig_kvart_paslag') | float(0) %}
            {% set el_cert   = states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) %}
            {% set el_moms   = 1 + (states('input_number.elhandel_rorlig_kvart_moms') | float(0) / 100) %}
            {% set nat_overf = states('input_number.nat_eloverforing') | float(0) %}
            {% set nat_skatt = states('input_number.nat_energiskatt') | float(0) %}
            {% set nat_moms  = 1 + (states('input_number.nat_moms') | float(0) / 100) %}
            {% set entries   = (today_price.get(area) or []) %}
            {% if entries %}
              {% set spot_max = (entries | map(attribute='price') | map('float') | list | max) / 1000 %}
              {{ (((spot_max + el_paslag + el_cert) * el_moms) + ((nat_overf + nat_skatt) * nat_moms)) | round(4) }}
            {% else %}unavailable{% endif %}

          raw_today: >
            {% set area      = 'SE3' %}
            {% set el_paslag = states('input_number.elhandel_rorlig_kvart_paslag') | float(0) %}
            {% set el_cert   = states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) %}
            {% set el_moms   = 1 + (states('input_number.elhandel_rorlig_kvart_moms') | float(0) / 100) %}
            {% set nat_overf = states('input_number.nat_eloverforing') | float(0) %}
            {% set nat_skatt = states('input_number.nat_energiskatt') | float(0) %}
            {% set nat_moms  = 1 + (states('input_number.nat_moms') | float(0) / 100) %}
            {% set entries   = (today_price.get(area) or []) %}
            {% set ns = namespace(r=[]) %}
            {% for s in entries %}
              {% set val = (((s.price/1000) + el_paslag + el_cert) * el_moms) + ((nat_overf + nat_skatt) * nat_moms) %}
              {% set ns.r = ns.r + [{
                'start': (s.start | as_datetime | as_local).isoformat(),
                'end':   (s.end   | as_datetime | as_local).isoformat(),
                'value': (val | round(4))
              }] %}
            {% endfor %}
            {{ ns.r }}

          raw_tomorrow: >
            {% set area      = 'SE3' %}
            {% set el_paslag = states('input_number.elhandel_rorlig_kvart_paslag') | float(0) %}
            {% set el_cert   = states('input_number.elhandel_rorlig_kvart_elcertifikat') | float(0) %}
            {% set el_moms   = 1 + (states('input_number.elhandel_rorlig_kvart_moms') | float(0) / 100) %}
            {% set nat_overf = states('input_number.nat_eloverforing') | float(0) %}
            {% set nat_skatt = states('input_number.nat_energiskatt') | float(0) %}
            {% set nat_moms  = 1 + (states('input_number.nat_moms') | float(0) / 100) %}
            {% set entries   = (tomorrow_price.get(area) or []) %}
            {% set ns = namespace(r=[]) %}
            {% for s in entries %}
              {% set val = (((s.price/1000) + el_paslag + el_cert) * el_moms) + ((nat_overf + nat_skatt) * nat_moms) %}
              {% set ns.r = ns.r + [{
                'start': (s.start | as_datetime | as_local).isoformat(),
                'end':   (s.end   | as_datetime | as_local).isoformat(),
                'value': (val | round(4))
              }] %}
            {% endfor %}
            {{ ns.r }}

          # — Solceller: försäljningspris —
          sell_price: >
            {% set area      = 'SE3' %}
            {% set sol_skatt = states('input_number.sol_skattereduktion') | float(0) %}
            {% set sol_inmat = states('input_number.sol_inmatningsersattning') | float(0) %}
            {% set entries   = (today_price.get(area) or []) %}
            {% set now_ts    = now().timestamp() %}
            {% set ns = namespace(v=None) %}
            {% for s in entries %}
              {% set st = as_timestamp(s.start) %}
              {% set en = as_timestamp(s.end) %}
              {% if st is not none and en is not none and st <= now_ts < en %}
                {% set spot = (s.price | float(0)) / 1000 %}
                {% set ns.v = spot + sol_skatt + sol_inmat %}
              {% endif %}
            {% endfor %}
            {{ ns.v | round(4) if ns.v is not none else 'unavailable' }}

          raw_today_sell: >
            {% set area      = 'SE3' %}
            {% set sol_skatt = states('input_number.sol_skattereduktion') | float(0) %}
            {% set sol_inmat = states('input_number.sol_inmatningsersattning') | float(0) %}
            {% set entries   = (today_price.get(area) or []) %}
            {% set ns = namespace(r=[]) %}
            {% for s in entries %}
              {% set val = (s.price / 1000) + sol_skatt + sol_inmat %}
              {% set ns.r = ns.r + [{
                'start': (s.start | as_datetime | as_local).isoformat(),
                'end':   (s.end   | as_datetime | as_local).isoformat(),
                'value': (val | round(4))
              }] %}
            {% endfor %}
            {{ ns.r }}

          net_buy_vs_sell: >
            {% set buy  = states('sensor.elpris_total_inkl_nat') | float(none) %}
            {% set sell = state_attr('sensor.elpris_total_inkl_nat', 'sell_price') | float(none) %}
            {{ (buy - sell) | round(4) if (buy is not none and sell is not none) else 'unavailable' }}

          hours_today: >
            {{ (today_price.get('SE3') or []) | length }}

          hours_tomorrow: >
            {{ (tomorrow_price.get('SE3') or []) | length }}

###############################################################################
# 3. ANALYSSENSORER - Koefficient, prisband & binära statusar
###############################################################################
  - sensor:
      - name: "Elpriskoefficient"
        unique_id: elpriskoefficient
        unit_of_measurement: ""
        icon: mdi:chart-line
        state: >
          {% set price = states('sensor.elpris_total_inkl_nat') | float(none) %}
          {% set pmax  = state_attr('sensor.elpris_total_inkl_nat', 'max') | float(none) %}
          {% set pmin  = state_attr('sensor.elpris_total_inkl_nat', 'min') | float(none) %}
          {% if price is none or pmax is none or pmin is none or pmax <= 0 %}
            {{ this.state | default(0) }}
          {% else %}
            {% set threshold = (pmax - pmin) * (1.3 * (pmax ** -0.7)) * (1 / (1 + pmin * 0.25)) + pmin %}
            {{ (price / threshold) | round(3) }}
          {% endif %}

      - name: "Nordpool price band"
        unique_id: nordpool_price_band_dynamic_minmax
        icon: mdi:traffic-light
        state: >
          {% set price = states('sensor.elpris_total_inkl_nat') | float(0) %}
          {% set pmin  = state_attr('sensor.elpris_total_inkl_nat', 'min') | float(price) %}
          {% set pmax  = state_attr('sensor.elpris_total_inkl_nat', 'max') | float(price) %}
          {% set span  = pmax - pmin %}
          {% if span <= 0 %}normal
          {% else %}
            {% set x    = (price - pmin) / span %}
            {% set prev = this.state | default('normal') %}
            {% set h    = 0.02 %}
            {% set t_vc = 0.15 + (h if prev == 'very_cheap'     else -h if prev == 'cheap'          else 0) %}
            {% set t_c  = 0.35 + (h if prev == 'cheap'          else -h if prev == 'normal'         else 0) %}
            {% set t_e  = 0.65 + (h if prev == 'normal'         else -h if prev == 'expensive'      else 0) %}
            {% set t_ve = 0.85 + (h if prev == 'expensive'      else -h if prev == 'very_expensive' else 0) %}
            {% if   x <= t_vc %}very_cheap
            {% elif x <= t_c  %}cheap
            {% elif x <  t_e  %}normal
            {% elif x <= t_ve %}expensive
            {% else            %}very_expensive
            {% endif %}
          {% endif %}

    binary_sensor:
      - name: "Elpris OK"
        unique_id: elpris_ok
        icon: mdi:check-circle
        state: >
          {% set k = states('sensor.elpriskoefficient') | float(none) %}
          {{ (k is not none) and (k < 1.0) }}

      - name: "Kort peak nu"
        unique_id: kort_peak_nu
        icon: mdi:alert
        state: >
          {% set k       = states('sensor.elpriskoefficient') | float(none) %}
          {% set entries = state_attr('sensor.elpris_total_inkl_nat', 'raw_today') or [] %}
          {{ (k is not none) and (entries | length > 2) and (k >= 1.2) }}

      - name: "Sol försäljning lönsam"
        unique_id: sol_forsaljning_lonsam
        icon: mdi:solar-power
        state: >
          {% set diff = state_attr('sensor.elpris_total_inkl_nat', 'net_buy_vs_sell') | float(none) %}
          {{ (diff is not none) and (diff > 0) }}

###############################################################################
# 4. DATABASLÖSNING - statistics + SQL
# (recorder-delen ska ligga i configuration.yaml enligt din kommentar)
###############################################################################
sensor:
  - platform: statistics
    name: "Elpris elhandel timstatistik"
    unique_id: elpris_elhandel_timstatistik
    entity_id: sensor.elpris_elhandel
    state_characteristic: mean
    max_age:
      hours: 24
    sampling_size: 1440

  - platform: statistics
    name: "Elpris total timstatistik"
    unique_id: elpris_total_timstatistik
    entity_id: sensor.elpris_total_inkl_nat
    state_characteristic: mean
    max_age:
      hours: 24
    sampling_size: 1440

sql:
  - name: "Elpris snitt igår"
    unique_id: elpris_snitt_igar
    query: >
      SELECT ROUND(AVG(CAST(state AS FLOAT)), 4) AS state
      FROM states
      INNER JOIN states_meta ON states.metadata_id = states_meta.metadata_id
      WHERE states_meta.entity_id = 'sensor.elpris_total_inkl_nat'
        AND CAST(state AS FLOAT) > 0
        AND last_updated_ts >= strftime('%s', 'now', '-1 day', 'start of day')
        AND last_updated_ts <  strftime('%s', 'now', 'start of day')
    column: state
    unit_of_measurement: "SEK/kWh"

  - name: "Elpris snitt denna vecka"
    unique_id: elpris_snitt_denna_vecka
    query: >
      SELECT ROUND(AVG(CAST(state AS FLOAT)), 4) AS state
      FROM states
      INNER JOIN states_meta ON states.metadata_id = states_meta.metadata_id
      WHERE states_meta.entity_id = 'sensor.elpris_total_inkl_nat'
        AND CAST(state AS FLOAT) > 0
        AND last_updated_ts >= strftime('%s', 'now', 'weekday 1', '-7 days', 'start of day')
    column: state
    unit_of_measurement: "SEK/kWh"
