title: SVOTC Main
icon: ""
badges: []
cards: []
type: sections
sections:
  - type: grid
    cards:
      - type: entities
        title: ğŸ›ï¸ SVOTC Kontroller
        state_color: true
        show_header_toggle: false
        entities:
          - entity: input_select.svotc_mode
            name: DriftslÃ¤ge
            icon: mdi:toggle-switch
          - type: section
            label: KomfortinstÃ¤llningar
          - entity: input_number.svotc_comfort_temperature
            name: MÃ¥ltemperatur
            icon: mdi:target
          - entity: input_number.svotc_comfort_guard_activate_below_c
            name: Aktivera komfortskydd (under mÃ¥l)
            icon: mdi:shield-alert
          - entity: input_number.svotc_comfort_guard_deactivate_above_c
            name: Avaktivera komfortskydd (nÃ¤ra mÃ¥l)
            icon: mdi:shield-check
          - entity: input_boolean.svotc_comfort_guard_enabled
            name: Komfortskydd aktiverat
            icon: mdi:shield-home
          - entity: automation.svotc_auto_tune_normal_house_defaults
            secondary_info: last-triggered
          - type: section
            label: Prisoptimering
          - entity: input_number.svotc_prebrake_lead_time_min
            name: FÃ¶rbromsning â€“ starta fÃ¶re (min)
            icon: mdi:timer-sand
          - entity: input_number.svotc_comfort_boost_max_c
            name: Komfortboost â€“ max (Â°C)
            icon: mdi:fire
          - entity: input_number.svotc_brake_hold_offset_c
            name: Max bromsoffset (Â°C)
            icon: mdi:thermometer-minus
          - type: section
            label: SystemhÃ¤lsa
          - entity: binary_sensor.svotc_inputs_healthy
            name: Temperatursensorer OK
            icon: mdi:thermometer-check
          - entity: binary_sensor.svotc_price_available
            name: Prisdata tillgÃ¤nglig
            icon: mdi:cash-check
          - entity: binary_sensor.svotc_comfort_guard_active
            name: Komfortskydd aktivt
            icon: mdi:shield-alert-outline
          - type: section
            label: Timing
          - entity: sensor.svotc_minutes_to_next_brake_start
            name: Minuter till nÃ¤sta dyr period
            icon: mdi:timer-outline
          - entity: sensor.svotc_prebrake_window_min
            name: FÃ¶rbromsfÃ¶nster (min)
            icon: mdi:window-open
      - type: custom:mini-graph-card
        name: ğŸ“ˆ Offset-utveckling (24h)
        hours_to_show: 24
        points_per_hour: 4
        line_width: 3
        font_size: 75
        animate: true
        show:
          labels: false
          legend: true
          icon: false
        entities:
          - entity: input_number.svotc_requested_offset_c
            name: BegÃ¤rd offset
            show_state: true
          - entity: input_number.svotc_applied_offset_c
            name: TillÃ¤mpad offset
            show_state: true
      - type: custom:mini-graph-card
        name: ğŸŒ¡ï¸ TemperaturÃ¶versikt (24h)
        hours_to_show: 24
        points_per_hour: 4
        line_width: 2
        font_size: 75
        animate: true
        show:
          labels: true
          legend: true
          icon: false
        entities:
          - entity: sensor.svotc_src_outdoor
            name: Utomhus (verklig)
            color: "#3498db"
            show_state: true
          - entity: sensor.svotc_virtual_outdoor_temperature
            name: Virtuell ute (â†’VP)
            color: "#9b59b6"
            show_state: true
    column_span: 1
  - type: grid
    cards:
      - type: markdown
        content: >
          {# =========================
             FÃ¶rberedelser / safe values
             ========================= #}

          {# Grundstatus #}

          {% set mode = states('input_select.svotc_mode') %}

          {% set reason = states('input_text.svotc_reason_code') %}

          {% set inputs_ok = is_state('binary_sensor.svotc_inputs_healthy',
          'on') %}

          {% set price_ok = is_state('binary_sensor.svotc_price_available',
          'on') %}


          {# Temperatur/offset #}

          {% set req = states('input_number.svotc_requested_offset_c') |
          float(0) %}

          {% set app = states('input_number.svotc_applied_offset_c') | float(0)
          %}

          {% set delta = req - app %}


          {# Pris #}

          {% set p_s = states('sensor.svotc_current_price') %}

          {% set p80_s = states('sensor.svotc_p80') %}

          {% set p = p_s | float(0) %}

          {% set p80 = p80_s | float(0) %}

          {% set p_ok_val = p_s not in ['unknown','unavailable','none',''] %}

          {% set p80_ok_val = p80_s not in ['unknown','unavailable','none','']
          %}


          {# Prebrake #}

          {% set ttn = states('sensor.svotc_minutes_to_next_brake_start') |
          float(999) %}

          {% set win = states('sensor.svotc_prebrake_window_min') | float(0) %}

          {% set pre = states('sensor.svotc_prebrake_strength') | float(0) %}

          {% set starts_in = (ttn - win) if (ttn < 900 and win > 0) else none %}


          {# Komfortskydd #}

          {% set guard_on =
          is_state('binary_sensor.svotc_comfort_guard_active','on') %}

          {% set guard_enabled =
          is_state('input_boolean.svotc_comfort_guard_enabled','on') %}

          {% set target = states('sensor.svotc_dynamic_target_temperature') |
          float(0) %}

          {% set indoor = states('sensor.svotc_src_indoor') | float(0) %}

          {% set act =
          states('input_number.svotc_comfort_guard_activate_below_c') | float(0)
          %}

          {% set deact =
          states('input_number.svotc_comfort_guard_deactivate_above_c') |
          float(0) %}

          {% set ignite_at = (target - act) | round(2) %}

          {% set release_at = (target - deact) | round(2) %}


          {# Bromsfas #}

          {% set phase = states('input_text.svotc_brake_phase') %}

          {% set phase_ts =
          as_timestamp(states('input_datetime.svotc_brake_phase_changed'),
          default=none) %}

          {% set phase_age = ((as_timestamp(now()) - phase_ts) / 60) if phase_ts
          is number else none %}

          {% set rampup = states('input_number.svotc_brake_rampup_duration_min')
          | float(0) %}

          {% set hold = states('input_number.svotc_brake_hold_duration_min') |
          float(0) %}

          {% set rampdown =
          states('input_number.svotc_brake_rampdown_duration_min') | float(0) %}


          {# Prisstatus #}

          {% set price_state = states('input_text.svotc_last_price_state') %}

          {% set raw = states('sensor.svotc_raw_price_state') %}


          {# Tid till nÃ¤sta dyrperiod som klockslag #}

          {% set mins = ttn %}

          {% set now_ts = as_timestamp(now()) %}

          {% set next_ts = (now_ts + (mins * 60)) if (mins is number and mins <
          900 and mins > 0) else none %}

          {% set next_hhmm = (next_ts | timestamp_custom('%H:%M', true)) if
          next_ts is not none else 'â€”' %}



          #### ğŸ“Š StatusÃ¶versikt


          **DriftslÃ¤ge:** `{{ mode }}`  

          **Strategi:** `{{ reason }}`  

          **SystemhÃ¤lsa:** {% if inputs_ok %}âœ… OK{% else %}âš ï¸ PROBLEM{% endif
          %}  

          **Prisdata:** {% if price_ok %}âœ… OK{% else %}âš ï¸ SAKNAS{% endif %}


          ---

          #### ğŸ§  Sammanfattning (varfÃ¶r?)


          **Reason:** `{{ reason }}`


          {% if reason == 'PRICE_BRAKE' %}

          ğŸ’¡ Bromsar vÃ¤rme (dyr el / prebrake)  

          - Pris: {% if p_ok_val %}{{ p }}{% else %}â€”{% endif %} (P80: {% if
          p80_ok_val %}{{ p80 }}{% else %}â€”{% endif %})

          - Prebrake: {{ (pre * 100) | round(0) }}%

          - Fas: {{ phase }}

          - Offset: {{ app | round(2) }}Â°C


          {% elif reason == 'COMFORT_GUARD' %}

          ğŸ›¡ï¸ Skyddar komfort (inne fÃ¶r lÃ¥g)  

          - Inne: {{ indoor | round(2) }}Â°C (aktiverar vid {{ ignite_at }}Â°C)

          - Offset: {{ app | round(2) }}Â°C


          {% elif reason == 'MCP_BLOCKS_BRAKE' %}

          ğŸ›¡ï¸ Komfort prioriteras (broms blockeras)  

          - Dyr el + lÃ¥g inne â†’ comfort guard vinner


          {% elif reason == 'NEUTRAL' %}

          âœ… Normal drift (ingen justering)


          {% elif reason == 'OFF' %}

          âš« Systemet Ã¤r avstÃ¤ngt


          {% elif reason == 'PASS_THROUGH' %}

          ğŸ“Š Ã–vervakningslÃ¤ge (ingen styrning)


          {% elif reason == 'COMFORT_ONLY' %}

          ğŸ›¡ï¸ Endast komfort (ingen prisstyrning)


          {% elif reason == 'MISSING_INPUTS_FREEZE' %}

          âš ï¸ Sensorer saknas (offset fryst)


          {% elif reason == 'PRICE_DATA_WARMUP_FREEZE' %}

          â³ Prisdata ej redo


          {% else %}

          â“ OkÃ¤nd strategi: {{ reason }}

          {% endif %}


          ---

          #### ğŸŒ¡ï¸ Temperaturer

          | Sensor | VÃ¤rde | Status |

          |--------|-------|--------|

          | ğŸ  Inne | **{{ states('sensor.svotc_src_indoor') }}Â°C** | MÃ¥l: {{
          states('sensor.svotc_dynamic_target_temperature') }}Â°C |

          | ğŸŒ¡ï¸ Ute (verklig) | **{{ states('sensor.svotc_src_outdoor') }}Â°C** |
          OK |

          | ğŸ¯ Virtuell (â†’VP) | **{{
          states('sensor.svotc_virtual_outdoor_temperature') }}Â°C** | Offset: {{
          states('input_number.svotc_applied_offset_c') }}Â°C |


          **Offsetstatus:**  

          BegÃ¤rd: **{{ req | round(2) }}Â°C**

          TillÃ¤mpad: **{{ app | round(2) }}Â°C**{% if delta | abs > 0.05 %}  â†’
          Rampar: {{ delta | round(2) }}Â°C{% endif %}


          ---

          #### ğŸ’° Prisstyrning

          **Aktuellt pris:** {{ states('sensor.svotc_src_current_price') }}
          SEK/kWh  

          **ReferensvÃ¤rden:** P30 {{ states('sensor.svotc_p30') }} | P80 {{
          states('sensor.svotc_p80') }}


          **Prisstatus:** {% if price_state == 'cheap' %}ğŸŸ¢ Billig{% elif
          price_state == 'brake' %}ğŸ”´ Dyr{% elif price_state == 'off' %}âš« Av{%
          else %}ğŸŸ¡ Neutral{% endif %}  

          (stabil: `{{ price_state }}` | rÃ¥: `{{ raw }}`)


          **Prebrake:**  

          {% if win <= 0 %}

          - âšª Inaktiv

          {% elif ttn == 0 %}

          - ğŸ”´ I dyrperiod nu

          {% elif pre > 0 %}

          - ğŸŸ¡ Aktiv: {{ (pre * 100) | round(0) }}% â€¢ Dyrperiod **{{ next_hhmm
          }}** (om {{ ttn | round(0) }} min)

          {% elif starts_in is not none and starts_in > 0 %}

          {% set wait_ts = now_ts + (starts_in * 60) %}

          - ğŸŸ¢ VÃ¤ntar: startar **{{ wait_ts | timestamp_custom('%H:%M', true)
          }}** (om {{ starts_in | round(0) }} min) â€¢ FÃ¶nster {{ win }} min

          {% else %}
           â±ï¸ NÃ¤sta dyrperiod: {% if ttn < 900 %}**{{ next_hhmm }}** (om {{ ttn | round(0) }} min){% else %}**ingen i sikte**{% endif %}
          {% endif %}

          ---

          #### ğŸ›¡ï¸ Komfortskydd

          {% set guard_on =
          is_state('binary_sensor.svotc_comfort_guard_active','on') %}

          {% set enabled =
          is_state('input_boolean.svotc_comfort_guard_enabled','on') %}

          {% set target = states('sensor.svotc_dynamic_target_temperature') |
          float(0) %}

          {% set indoor = states('sensor.svotc_src_indoor') | float(0) %}

          {% set act =
          states('input_number.svotc_comfort_guard_activate_below_c') | float(0)
          %}

          {% set deact =
          states('input_number.svotc_comfort_guard_deactivate_above_c') |
          float(0) %}


          {% set ignite_at  = (target - act) | round(2) %}

          {% set release_at = (target - deact) | round(2) %}


          **Status:** {% if not enabled %}ğŸ”´ AVSTÃ„NGD{% elif guard_on %}ğŸŸ¢
          AKTIV{% else %}âšª Standby{% endif %}


          {% if enabled %}

          **MÃ¥l:** **{{ target | round(2) }}Â°C** â€¢ **Inne:** **{{ indoor |
          round(2) }}Â°C**


          â„ï¸ **Aktivt** om inne < **{{ ignite_at }}Â°C**  *(mÃ¥l âˆ’ {{ act }}Â°C)*

          ğŸ”¥ **SlÃ¤pper** om inne â‰¥ **{{ release_at }}Â°C** *(mÃ¥l âˆ’ {{ deact
          }}Â°C)*


          {% if guard_on %}
            {% set left = (release_at - indoor) | round(2) %}
            {% if left > 0 %}
          â¡ï¸ Kvar tills den aktiveras: **{{ left }}Â°C**
            {% else %}
          â¡ï¸ Ã–ver slÃ¤ckgrÃ¤nsen med **{{ (-left) | round(2) }}Â°C** (bÃ¶r slÃ¤cka
          nÃ¤r uppdatering/automation slÃ¥r igenom)
            {% endif %}
          {% else %}
            {% set left = (indoor - ignite_at) | round(2) %}
            {% if left > 0 %}
          â¡ï¸ Kvar tills den aktiveras: **{{ left }}Â°C**
            {% else %}
          â¡ï¸ Under grÃ¤nsen med **{{ (-left) | round(2) }}Â°C** (bÃ¶r avvaktiveras
          nÃ¤r uppdatering/automation slÃ¥r igenom)
            {% endif %}
          {% endif %}

          {% endif %}


          ---


          **Aktuell fas:** 

          {% if phase == 'idle' %}âšª Vilar

          {% elif phase == 'ramping_up' %}ğŸŸ¡ Rampar upp{% if phase_age is not
          none %} ({{ phase_age | round(1) }}/{{ rampup }} min){% endif %}

          {% elif phase == 'holding' %}ğŸ”´ HÃ¥ller{% if phase_age is not none %}
          ({{ phase_age | round(1) }}/{{ hold }} min){% endif %}

          {% elif phase == 'ramping_down' %}ğŸŸ¢ Rampar ner{% if phase_age is not
          none %} ({{ phase_age | round(1) }}/{{ rampdown }} min){% endif %}

          {% else %}â“ {{ phase }}

          {% endif %}


          ---

          **Version:** `{{ states('input_text.svotc_version') }}`

          *Uppdaterad: {{ now().strftime('%Y-%m-%d %H:%M:%S') }}*
        title: SVOTC â€“ MAIN (Statuskort)
max_columns: 4
